var common = {};

// Show the form
common.form = 'user';

function initPage($) {

  COMPONENT('form', 'zindex:12', function(self, config) {

    var W = window;
    var csspos = {};

    if (!W.$$form) {

      W.$$form_level = W.$$form_level || 1;
      W.$$form = true;

      $(document).on('click', '.ui-form-button-close', function() {
        SET($(this).attrd('path'), '');
      });

      $(W).on('resize', function() {
        SETTER('form', 'resize');
      });

      $(document).on('click', '.ui-form-container', function(e) {
        var el = $(e.target);
        if (!(el.hclass('ui-form-container-padding') || el.hclass('ui-form-container')))
          return;
        var form = $(this).find('.ui-form');
        var cls = 'ui-form-animate-click';
        form.aclass(cls);
        setTimeout(function() {
          form.rclass(cls);
        }, 300);
      });
    }

    self.readonly();
    self.submit = function() {
      if (config.submit)
        EXEC(config.submit, self);
      else
        self.hide();
    };

    self.cancel = function() {
      config.cancel && EXEC(config.cancel, self);
      self.hide();
    };

    self.hide = function() {
      self.set('');
    };

    self.icon = function(value) {
      var el = this.rclass2('fa');
      value.icon && el.aclass('fa fa-' + value.icon);
    };

    self.resize = function() {
      if (!config.center || self.hclass('hidden'))
        return;
      var ui = self.find('.ui-form');
      var fh = ui.innerHeight();
      var wh = $(W).height();
      var r = (wh / 2) - (fh / 2);
      csspos.marginTop = (r > 30 ? (r - 15) : 20) + 'px';
      ui.css(csspos);
    };

    self.make = function() {

      $(document.body).append('<div id="{0}" class="hidden ui-form-container"><div class="ui-form-container-padding"><div class="ui-form" style="max-width:{1}px"><div data-bind="@config__html span:value.title__change .ui-form-icon:@icon" class="ui-form-title"><button class="ui-form-button-close{3}" data-path="{2}"><i class="fa fa-times"></i></button><i class="ui-form-icon"></i><span></span></div></div></div>'.format(self.ID, config.width || 800, self.path, config.closebutton == false ? ' hidden' : ''));
      var el = $('#' + self.ID);
      el.find('.ui-form')[0].appendChild(self.dom);
      self.rclass('hidden');
      self.replace(el);

      self.event('scroll', function() {
        EMIT('scroll', self.name);
        EMIT('reflow', self.name);
      });

      self.find('button').on('click', function() {
        switch (this.name) {
          case 'submit':
            self.submit(self.hide);
            break;
          case 'cancel':
            !this.disabled && self[this.name](self.hide);
            break;
        }
      });

      config.enter && self.event('keydown', 'input', function(e) {
        e.which === 13 && !self.find('button[name="submit"]')[0].disabled && setTimeout(function() {
          self.submit(self);
        }, 800);
      });
    };

    self.configure = function(key, value, init, prev) {
      if (init)
        return;
      switch (key) {
        case 'width':
          value !== prev && self.find('.ui-form').css('max-width', value + 'px');
          break;
        case 'closebutton':
          self.find('.ui-form-button-close').tclass('hidden', value !== true);
          break;
      }
    };

    self.setter = function(value) {

      setTimeout2('ui-form-noscroll', function() {
        $('html').tclass('ui-form-noscroll', !!$('.ui-form-container').not('.hidden').length);
      }, 50);

      var isHidden = value !== config.if;

      if (self.hclass('hidden') === isHidden)
        return;

      setTimeout2('formreflow', function() {
        EMIT('reflow', self.name);
      }, 10);

      if (isHidden) {
        self.aclass('hidden');
        self.release(true);
        self.find('.ui-form').rclass('ui-form-animate');
        W.$$form_level--;
        return;
      }

      if (W.$$form_level < 1)
        W.$$form_level = 1;

      W.$$form_level++;

      self.css('z-index', W.$$form_level * config.zindex);
      self.element.scrollTop(0);
      self.rclass('hidden');

      self.resize();
      self.release(false);

      config.reload && EXEC(config.reload, self);
      config.default && DEFAULT(config.default, true);

      if (!isMOBILE && config.autofocus) {
        var el = self.find(config.autofocus === true ? 'input[type="text"],select,textarea' : config.autofocus);
        el.length && el[0].focus();
      }

      setTimeout(function() {
        self.element.scrollTop(0);
        self.find('.ui-form').aclass('ui-form-animate');
      }, 300);

      // Fixes a problem with freezing of scrolling in Chrome
      setTimeout2(self.ID, function() {
        self.css('z-index', (W.$$form_level * config.zindex) + 1);
      }, 500);
    };
  });
  COMPILE();
      
  /*
  ... data-jc-init="init_user_form" ...
  function init_user_form(component) {
    component.submit = function(hide) { alert('SUBMIT'); hide(); };
    component.cancel = function(hide) { alert('CANCEL'); hide(); };
  }
  */

  function userform_submit(component) {
    alert('SUBMIT');
    component.hide();
  }

}