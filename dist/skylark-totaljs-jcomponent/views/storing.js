/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["../langx","../binding/pathmaker"],function(t,e){var r={sort:1,reverse:1,splice:1,slice:1,pop:1,unshift:1,shift:1,push:1},n=/\[\d+\]$/;return function(i){var a={},s="",u=i.eventer,o=i.binding,d=i.option("store");function l(t){for(var e=t.split("."),r=[],n=[],i=0;i<e.length;i++){var a=e[i],s=a.indexOf("[");if(-1===s)if(-1===a.indexOf("-"))n.push(a),r.push(n.join("."));else{var u=n.splice(n.length-1);n.push(u+"['"+a+"']"),r.push(n.join("."))}else-1===a.indexOf("-")?(n.push(a.substring(0,s)),r.push(n.join(".")),n.splice(n.length-1),n.push(a),r.push(n.join("."))):(n.push("['"+a.substring(0,s)+"']"),r.push(n.join("")),n.push(a.substring(s)),r.push(n.join("")))}return r}var c={},f={},v=[],h={};function a(t,e,r){var n="$jcpath";if(WATCH(t,function(r,i){var a=storages.get(n);a?a[t]=i:(a={})[t]=i,storages.put(n,a,e)}),void 0===r||r){var i=storages.get(n);i&&void 0!==i[t]&&i[t]!==p(t)&&g(t,i[t],!0)}return this}function p(t,e){if(null!=t){37===t.charCodeAt(0)&&(t="jctmp."+t.substring(1));var r="="+t;if(c[r])return c[r](e||d.data);if(-1===t.indexOf("?")){for(var n=l(t),i=[],a=0,s=n.length-1;a<s;a++){var u=n[a];"["!==u.substring(0,1)&&(u="."+u),i.push("if(!w"+u+")return")}var o=n[n.length-1];"["!==o.substring(0,1)&&(o="."+o);var f=new Function("w",i.join(";")+";return w"+o);return c[r]=f,f(e||d.data)}}}function b(t,e,r){if(null!=t){var i="+"+t;if(c[i])return c[i](d.data,e,t,o.binders,o.binderbind,r);if(-1===t.indexOf("?")){for(var a=l(t),s=[],u=[],f=0;f<a.length-1;f++){var v=a[f],h=a[f+1]&&n.test(a[f+1])?"[]":"{}",p="w"+("["===v.substring(0,1)?"":".")+v;s.push("if(typeof("+p+")!=='object'||"+p+"==null)"+p+"="+h)}for(f=0;f<a.length-1;f++)v=a[f],u.push("binders['"+v+"']&&binderbind('"+v+"','"+t+"',$ticks)");var b=a[a.length-1];u.push("binders['"+b+"']&&binderbind('"+b+"','"+t+"',$ticks)"),u.push("binders['!"+b+"']&&binderbind('!"+b+"','"+t+"',$ticks)"),"["!==b.substring(0,1)&&(b="."+b);var g=new Function("w","a","b","binders","binderbind","nobind","var $ticks=Math.random().toString().substring(2,8);if(!nobind){"+s.join(";")+";var v=typeof(a)=='function'?a(MAIN.compiler.get(b)):a;w"+b+"=v}"+u.join(";")+";return a");return c[i]=g,g(d.data,e,t,o.binders,o.binderbind,r),this}t=""}}function g(t,r,n){if(t instanceof Array){for(var a=0;a<t.length;a++)g(t[a],r,n);return this}if(!(t=e(t)))return this;if(33===t.charCodeAt(0)&&(t=t.substring(1)),43===t.charCodeAt(0))return y(t=t.substring(1),r,n);if(!t)return this;var o="object"==typeof r&&!(r instanceof Array)&&null!=r,d=!0===n;if(d&&(n=1),s=t,b(t,r),o)return $(t,d,n,!0);var l=p(t),c=[];void 0===n&&(n=1);for(var f=i.componenter.components,v=(a=0,f.length);a<v;a++){var h=f[a];h&&!h.disabled&&!h.$removed&&h.$loaded&&h.path&&h.$compare(t)&&(h.setter&&(h.path===t?h.setter&&(h.setterX(l,t,n),h.$interaction(n)):h.setter&&(h.setterX(p(h.path),t,n),h.$interaction(n))),h.$ready||(h.$ready=!0),3!==n&&h.state&&c.push(h),d?(h.$dirty_disabled||(h.$dirty=!0),h.$valid_disabled||(h.$valid=!0,h.$validate=!1,h.validate&&(h.$valid=h.validate(l),h.$interaction(102))),findControl2(h)):h.validate&&!h.$valid_disabled&&h.valid(h.validate(l),!0))}for(d&&caches.clear("dirty","valid"),a=0,v=c.length;a<v;a++)c[a].stateX(n,5);return u.emitwatch(t,l,n),this}function $(t,r,n,a){if(t instanceof Array){for(var o=0;o<t.length;o++)$(d,t[o],r,n);return this}if(!(t=e(t)))return this;if(33===t.charCodeAt(0)&&(t=t.substring(1)),!(t=t.replaceWildcard()))return this;a||p(t,p(t));var l=[];void 0===n&&(n=1),s=t;for(var c=i.componenter.components,f=(o=0,c.length);o<f;o++){var v=c[o];if(v&&!v.disabled&&!v.$removed&&v.$loaded&&v.path&&v.$compare(t)){var h=v.get();v.setter&&(v.$skip=!1,v.setterX(h,t,n),v.$interaction(n)),v.$ready||(v.$ready=!0),!0===r?(v.$dirty_disabled||(v.$dirty=!0,v.$interaction(101)),v.$valid_disabled||(v.$valid=!0,v.$validate=!1,v.validate&&(v.$valid=v.validate(h),v.$interaction(102))),findControl2(v)):v.validate&&!v.$valid_disabled&&v.valid(v.validate(h),!0),v.state&&l.push(v)}}for(r&&clear("dirty","valid"),o=0,f=l.length;o<f;o++)l[o].stateX(1,4);return u.emitwatch(t,p(t),n),this}function y(t,e,r){if(t instanceof Array){for(var n=0;n<t.length;n++)y(t[n],e,r);return this}var i=p(t),a=!1;i instanceof Array||(i=[],a=!0);var u=!0;return s=t,e instanceof Array?e.length?i.push.apply(i,e):u=!1:i.push(e),a?g(t,i,r):u&&$(t,void 0,r),this}function m(t,e){return null==e&&(e=!0),!com_dirty(t,!e)}function x(e){var r,n=[],i=1,a=!1,s=this;!0===e&&(a=!0,e=arguments[1],i=2),e=e.env();for(var u=i;u<arguments.length;u++)n.push(arguments[u]);var o=e.charCodeAt(0);if(35===o)return r=e.substring(1),a?!events[r]&&exechelper(s,e,n):EMIT.call(s,r,n[0],n[1],n[2],n[3],n[4]),EXEC;var d=0;if(64===o){var l=e.indexOf(".");if(r=e.substring(1,l),v=plugins.find(r)){var f=v[e.substring(l+1)];t.isFunction(f)&&(f.apply(s===Window?v:s,n),d=1)}return a&&!d&&exechelper(s,e,n),EXEC}if(-1!==(l=e.indexOf("/"))){r=e.substring(0,l);var v=plugins.find(r);return f=e.substring(l+1),v&&t.isFunction(v[f])&&(v[f].apply(s===W?v:s,n),d=1),a&&!d&&exechelper(s,e,n),EXEC}return f=c.get(e),t.isFunction(f)&&(f.apply(s,n),d=1),a&&!d&&exechelper(s,e,n),x}function _(t,r,n){if(r>0)return setTimeout(function(){_(t)},r),this;t=e(t).replaceWildcard();for(var a=[],s=i.componenter.components,u=0,o=s.length;u<o;u++){var d=s[u];d&&!d.$removed&&!d.disabled&&d.$loaded&&d.path&&d.$compare(t)&&(d.state&&a.push(d),n&&n._id!==d._id||(findControl2(d),d.$dirty_disabled||(d.$dirty=!0,d.$interaction(101)),d.$valid_disabled||(d.$valid=!0,d.$validate=!1,d.validate&&(d.$valid=d.validate(d.get()),d.$interaction(102)))))}return clear("valid","dirty"),state(a,1,3),this}function w(e,r,n){if(t.isFunction(e))return!0===r?$parser.unshift(e):$parser.push(e),this;var i=$parser;if(i&&i.length)for(var a=0,s=i.length;a<s;a++)e=i[a].call(this,r,e,n);return e}return $parser=[],nmCache={},temp={},w(function(e,r,n){switch(n){case"number":case"currency":case"float":var i=+(t.isString(r)?r.trimAll().replace(REGCOMMA,"."):r);return isNaN(i)?null:i;case"date":case"datetime":return r?r instanceof Date?r:(r=r.parseDate())&&r.getTime()?r:null:null}return r}),{bind:function t(r){if(r instanceof Array){for(var n=0;n<r.length;n++)t(r[n]);return this}if(!(r=e(r)))return this;33===r.charCodeAt(0)&&(r=r.substring(1)),(r=r.replaceWildcard())&&b(r,p(r),!0)},cache:a,can:function(t,r){return t=e(t),!com_dirty(t,r)&&com_valid(t,r)},change:m,changed:function(t){return!com_dirty(t)},create:function(e){var n,i=!1;if(t.isString(e)){if(proxy[e])return proxy[e];i=!0,n=function(t){var r=e+(t?"."+t:"");s!==r?setTimeout(function(){s===r?s="":(notify(r),_(r))},MD.delaybinder):s=""}}else n=e;var a=!1,u=e&&p(e)||{},o={get:function(t,e,r){try{return new Proxy(t[e],o)}catch(n){return Reflect.get(t,e,r)}},defineProperty:function(t,e,r){return!a&&n(e,r),Reflect.defineProperty(t,e,r)},deleteProperty:function(t,e){return!a&&n(e),Reflect.deleteProperty(t,e)},apply:function(t,e,i){if(r[t.name]){a=!0;var s=Reflect.apply(t,e,i);return n("",i[0]),a=!1,s}return Reflect.apply(t,e,i)}},d=new Proxy(u,o);return i?(s=e,null==p(e)&&g(e,u,!0),proxy[e]=d):d},default:function r(n,s,u,o){if(s>0)return setTimeout(function(){r(n,0,u,o)},s),this;"boolean"==typeof u&&(o=u,u=null),void 0===o&&(o=!0);var d=(n=e(n.replaceWildcard())).replace(/\.\*$/,""),l=f["#"+t.hashCode(d)];l&&b(d,l());for(var c=[],v=i.componenter.components,h=0,p=v.length;h<p;h++){var g=v[h];if(g&&!g.$removed&&!g.disabled&&g.$loaded&&g.path&&g.$compare(n)&&(g.state&&c.push(g),!u||u._id===g._id)){if(g.$default&&g.set(g.$default(),3),!o)return;findControl2(g),g.$dirty_disabled||(g.$dirty=!0),g.$valid_disabled||(g.$valid=!0,g.$validate=!1,g.validate&&(g.$valid=g.validate(g.get()),g.$interaction(102)))}}return o&&(a.clearPageData("valid","dirty"),t.state(c,3,3)),this},disabled:function(t,r){return t=e(t),com_dirty(t,r)||!com_valid(t,r)},errors:function(r,n,i){r instanceof Array&&(n=r,r=void 0),!0===n&&(n=i instanceof Array?i:null,i=!0);var a=[];return each(function(t){t.disabled||n&&t.$except(n)||!1!==t.$valid||t.$valid_disabled||a.push(t)},e(r)),i&&t.state(a,1,1),a},evaluate:function(t,e,r){var n="eval"+e,i=temp[n],a=null;return a=r?t:p(t),i?i.call(a,a,t):(-1===e.indexOf("return")&&(e="return "+e),i=new Function("value","path",e),temp[n]=i,i.call(a,a,t))},exec:x,exec2:function(t,e){var r=!0===t;return function(n,i,a,s){r?x(e,t,n,i,a,s):x(t,n,i,a,s)}},extend:function(r,n,i){if(r=e(r)){var a=p(r);null==a&&(a={}),g(r,t.extend(a,n),i)}return this},format:function(e,r,n){if(t.isFunction(e))return!0===r?v.unshift(e):v.push(e),this;var i=v;if(i&&i.length)for(var a=0,s=i.length;a<s;a++){var u=i[a].call(M,r,e,n);void 0!==u&&(e=u)}return e},get:p,inc:function e(r,n,i){if(r instanceof Array){for(var a=0;a<r.length;a++)e(r[a],n,i);return this}if(!r)return this;var s=p(r);return s?t.isNumber(s)||(s=parseFloat(s),isNaN(s)&&(s=0)):s=0,g(r,s+=n,i),this},invalid:function(t,r){return(t=e(t))&&(com_dirty(t,!1,r,!0),com_valid(t,!1,r)),W},make:function(t,e,r){switch(typeof t){case"function":e=t,t={};break;case"string":var n=t,i=!0;return null==(t=p(n))&&(i=!1,t={}),e.call(t,t,n,function(e,r){g(t,e,r)}),!i||void 0!==r&&!0!==r?C.ready?b(n,t):g(n,t,!0):r(n,!0),t}return e.call(t,t,""),t},modify:function e(r,n,i){return r&&"object"==typeof r?Object.keys(r).forEach(function(t){e(t,r[t],n)}):(t.isFunction(n)&&(n=n(p(r))),g(r,n,i),i?t.setTimeout(m,i+5,r):m(r)),this},modified:function(t){var r=[];return each(function(t){t.disabled||t.$dirty_disabled||!1===t.$dirty&&r.push(t.path)},e(t)),r},parser:w,paths:c,push:y,reset:_,rewrite:function(t,r,n){return(t=e(t))&&(s=t,b(t,r),u.emitwatch(t,r,n)),this},set:b,set2:function(t,e,r){if(null!=e){var i="++"+e;if(c[i])return c[i](t,r,e);for(var a=l(e),s=[],u=0;u<a.length-1;u++){var o=a[u],d=a[u+1]&&n.test(a[u+1])?"[]":"{}",f="w"+("["===o.substring(0,1)?"":".")+o;s.push("if(typeof("+f+")!=='object'||"+f+"==null)"+f+"="+d)}var v=a[a.length-1];"["!==v.substring(0,1)&&(v="."+v);var h=new Function("w","a","b",s.join(";")+";w"+v+"=a;return a");return c[i]=h,h(t,r,e),t}},setx:g,skipInc:function(){for(var t=0;t<arguments.length;t++)for(var e=arguments[t].split(","),r=0,n=e.length;r<n;r++){var i=e[r].trim();h[i]?h[i]++:h[i]=1}},skipDec:function(t){return!(h[t]&&--h[t]<=0&&(delete h[t],1))},update:$,used:function(t){return each(function(t){!t.disabled&&t.used()},t),this}}}});
//# sourceMappingURL=../sourcemaps/views/storing.js.map
