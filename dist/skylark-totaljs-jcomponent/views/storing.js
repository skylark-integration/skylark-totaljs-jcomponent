/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["../langx","../utils/storage","../binding/pathmaker"],function(e,t,r){var n={sort:1,reverse:1,splice:1,slice:1,pop:1,unshift:1,shift:1,push:1},i=/\[\d+\]$/;return function(a){var o="",u=a.eventer,s=a.binding,l=a.helper,d=a.cache,c=a.option("store");function f(e){for(var t=e.split("."),r=[],n=[],i=0;i<t.length;i++){var a=t[i],o=a.indexOf("[");if(-1===o)if(-1===a.indexOf("-"))n.push(a),r.push(n.join("."));else{var u=n.splice(n.length-1);n.push(u+"['"+a+"']"),r.push(n.join("."))}else-1===a.indexOf("-")?(n.push(a.substring(0,o)),r.push(n.join(".")),n.splice(n.length-1),n.push(a),r.push(n.join("."))):(n.push("['"+a.substring(0,o)+"']"),r.push(n.join("")),n.push(a.substring(o)),r.push(n.join("")))}return r}var v={},h={},p=[],b={};function g(e,t){if(null!=e){37===e.charCodeAt(0)&&(e="jctmp."+e.substring(1));var r="="+e;if(v[r])return v[r](t||c.data);if(-1===e.indexOf("?")){for(var n=f(e),i=[],a=0,o=n.length-1;a<o;a++){var u=n[a];"["!==u.substring(0,1)&&(u="."+u),i.push("if(!w"+u+")return")}var s=n[n.length-1];"["!==s.substring(0,1)&&(s="."+s);var l=new Function("w",i.join(";")+";return w"+s);return v[r]=l,l(t||c.data)}}}function m(e,t,r){if(null!=e){var n="+"+e;if(v[n])return v[n](c.data,t,e,s.binders,s.binderbind,r);if(-1===e.indexOf("?")){for(var a=f(e),o=[],u=[],l=0;l<a.length-1;l++){var d=a[l],h=a[l+1]&&i.test(a[l+1])?"[]":"{}",p="w"+("["===d.substring(0,1)?"":".")+d;o.push("if(typeof("+p+")!=='object'||"+p+"==null)"+p+"="+h)}for(l=0;l<a.length-1;l++)d=a[l],u.push("binders['"+d+"']&&binderbind('"+d+"','"+e+"',$ticks)");var b=a[a.length-1];u.push("binders['"+b+"']&&binderbind('"+b+"','"+e+"',$ticks)"),u.push("binders['!"+b+"']&&binderbind('!"+b+"','"+e+"',$ticks)"),"["!==b.substring(0,1)&&(b="."+b);var g=new Function("w","a","b","binders","binderbind","nobind","var $ticks=Math.random().toString().substring(2,8);if(!nobind){"+o.join(";")+";var v=typeof(a)=='function'?a(MAIN.compiler.get(b)):a;w"+b+"=v}"+u.join(";")+";return a");return v[n]=g,g(c.data,t,e,s.binders,s.binderbind,r),this}e=""}}function $(e,t,n){if(e instanceof Array){for(var i=0;i<e.length;i++)$(e[i],t,n);return this}if(!(e=r(e)))return this;if(33===e.charCodeAt(0)&&(e=e.substring(1)),43===e.charCodeAt(0))return x(e=e.substring(1),t,n);if(!e)return this;var s="object"==typeof t&&!(t instanceof Array)&&null!=t,c=!0===n;if(c&&(n=1),o=e,m(e,t),s)return y(e,c,n,!0);var f=g(e),v=[];void 0===n&&(n=1);for(var h=a.componenter.components,p=(i=0,h.length);i<p;i++){var b=h[i];b&&!b.disabled&&!b.$removed&&b.$loaded&&b.path&&b.$compare(e)&&(b.setter&&(b.path===e?b.setter&&(b.setterX(f,e,n),b.$interaction(n)):b.setter&&(b.setterX(g(b.path),e,n),b.$interaction(n))),b.$ready||(b.$ready=!0),3!==n&&b.state&&v.push(b),c?(b.$dirty_disabled||(b.$dirty=!0),b.$valid_disabled||(b.$valid=!0,b.$validate=!1,b.validate&&(b.$valid=b.validate(f),b.$interaction(102))),l.findControl2(b)):b.validate&&!b.$valid_disabled&&b.valid(b.validate(f),!0))}for(c&&d.clear("dirty","valid"),i=0,p=v.length;i<p;i++)v[i].stateX(n,5);return u.emitwatch(e,f,n),this}function y(e,t,n,i){if(e instanceof Array){for(var s=0;s<e.length;s++)y(c,e[s],t,n);return this}if(!(e=r(e)))return this;if(33===e.charCodeAt(0)&&(e=e.substring(1)),!(e=e.replaceWildcard()))return this;i||g(e,g(e));var f=[];void 0===n&&(n=1),o=e;for(var v=a.componenter.components,h=(s=0,v.length);s<h;s++){var p=v[s];if(p&&!p.disabled&&!p.$removed&&p.$loaded&&p.path&&p.$compare(e)){var b=p.get();p.setter&&(p.$skip=!1,p.setterX(b,e,n),p.$interaction(n)),p.$ready||(p.$ready=!0),!0===t?(p.$dirty_disabled||(p.$dirty=!0,p.$interaction(101)),p.$valid_disabled||(p.$valid=!0,p.$validate=!1,p.validate&&(p.$valid=p.validate(b),p.$interaction(102))),l.findControl2(p)):p.validate&&!p.$valid_disabled&&p.valid(p.validate(b),!0),p.state&&f.push(p)}}for(t&&d.clear("dirty","valid"),s=0,h=f.length;s<h;s++)f[s].stateX(1,4);return u.emitwatch(e,g(e),n),this}function x(e,t,r){if(e instanceof Array){for(var n=0;n<e.length;n++)x(e[n],t,r);return this}var i=g(e),a=!1;i instanceof Array||(i=[],a=!0);var u=!0;return o=e,t instanceof Array?t.length?i.push.apply(i,t):u=!1:i.push(t),a?$(e,i,r):u&&y(e,void 0,r),this}function _(e,t){return null==t&&(t=!0),!a.componenter.com_dirty(e,!t)}function w(t){var r,n=[],i=1,o=!1,u=this;!0===t&&(o=!0,t=arguments[1],i=2),t=t.env();for(var s=i;s<arguments.length;s++)n.push(arguments[s]);var l=t.charCodeAt(0);if(35===l)return r=t.substring(1),o?!events[r]&&exechelper(u,t,n):EMIT.call(u,r,n[0],n[1],n[2],n[3],n[4]),EXEC;var d=0;if(64===l){var c=t.indexOf(".");if(r=t.substring(1,c),v=a.plugins.find(r)){var f=v[t.substring(c+1)];e.isFunction(f)&&(f.apply(u===Window?v:u,n),d=1)}return o&&!d&&exechelper(u,t,n),EXEC}if(-1!==(c=t.indexOf("/"))){r=t.substring(0,c);var v=a.plugins.find(r);return f=t.substring(c+1),v&&e.isFunction(v[f])&&(v[f].apply(u===W?v:u,n),d=1),o&&!d&&exechelper(u,t,n),EXEC}return f=g(t),e.isFunction(f)&&(f.apply(u,n),d=1),o&&!d&&exechelper(u,t,n),w}function A(e,t,n){if(t>0)return setTimeout(function(){A(e)},t),this;e=r(e).replaceWildcard();for(var i=[],o=a.componenter.components,u=0,s=o.length;u<s;u++){var c=o[u];c&&!c.$removed&&!c.disabled&&c.$loaded&&c.path&&c.$compare(e)&&(c.state&&i.push(c),n&&n._id!==c._id||(l.findControl2(c),c.$dirty_disabled||(c.$dirty=!0,c.$interaction(101)),c.$valid_disabled||(c.$valid=!0,c.$validate=!1,c.validate&&(c.$valid=c.validate(c.get()),c.$interaction(102)))))}return d.clear("valid","dirty"),a.componenter.state(i,1,3),this}function j(t,r,n){if(e.isFunction(t))return!0===r?$parser.unshift(t):$parser.push(t),this;var i=$parser;if(i&&i.length)for(var a=0,o=i.length;a<o;a++)t=i[a].call(this,r,t,n);return t}$parser=[],nmCache={},temp={},j(function(t,r,n){switch(n){case"number":case"currency":case"float":var i=+(e.isString(r)?r.trimAll().replace(REGCOMMA,"."):r);return isNaN(i)?null:i;case"date":case"datetime":return r?r instanceof Date?r:(r=r.parseDate())&&r.getTime()?r:null:null}return r});var C={};return{bind:function e(t){if(t instanceof Array){for(var n=0;n<t.length;n++)e(t[n]);return this}if(!(t=r(t)))return this;33===t.charCodeAt(0)&&(t=t.substring(1)),(t=t.replaceWildcard())&&m(t,g(t),!0)},cachePath:function(e,r,n){var i="$jcpath";if(WATCH(e,function(n,a){var o=t(i);o?o[e]=a:(o={})[e]=a,t(i,o,r)}),void 0===n||n){var a=t(i);a&&void 0!==a[e]&&a[e]!==g(e)&&$(e,a[e],!0)}return this},can:function(e,t){return e=r(e),!a.componenter.com_dirty(e,t)&&a.componenter.com_valid(e,t)},change:_,changed:function(e){return!a.componenter.com_dirty(e)},create:function(t){var r,i=!1;if(e.isString(t)){if(proxy[t])return proxy[t];i=!0,r=function(e){var r=t+(e?"."+e:"");o!==r?setTimeout(function(){o===r?o="":(notify(r),A(r))},MD.delaybinder):o=""}}else r=t;var a=!1,u=t&&g(t)||{},s={get:function(e,t,r){try{return new Proxy(e[t],s)}catch(n){return Reflect.get(e,t,r)}},defineProperty:function(e,t,n){return!a&&r(t,n),Reflect.defineProperty(e,t,n)},deleteProperty:function(e,t){return!a&&r(t),Reflect.deleteProperty(e,t)},apply:function(e,t,i){if(n[e.name]){a=!0;var o=Reflect.apply(e,t,i);return r("",i[0]),a=!1,o}return Reflect.apply(e,t,i)}},l=new Proxy(u,s);return i?(o=t,null==g(t)&&$(t,u,!0),proxy[t]=l):l},default:function t(n,i,o,u){if(i>0)return setTimeout(function(){t(n,0,o,u)},i),this;"boolean"==typeof o&&(u=o,o=null),void 0===u&&(u=!0);var s=(n=r(n.replaceWildcard())).replace(/\.\*$/,""),c=h["#"+e.hashCode(s)];c&&m(s,c());for(var f=[],v=a.componenter.components,p=0,b=v.length;p<b;p++){var g=v[p];if(g&&!g.$removed&&!g.disabled&&g.$loaded&&g.path&&g.$compare(n)&&(g.state&&f.push(g),!o||o._id===g._id)){if(g.$default&&g.set(g.$default(),3),!u)return;l.findControl2(g),g.$dirty_disabled||(g.$dirty=!0),g.$valid_disabled||(g.$valid=!0,g.$validate=!1,g.validate&&(g.$valid=g.validate(g.get()),g.$interaction(102)))}}return u&&(d.clearPageData("valid","dirty"),a.componenter.state(f,3,3)),this},disabled:function(e,t){return e=r(e),a.componenter.com_dirty(e,t)||!a.componenter.com_valid(e,t)},errors:function(t,n,i){t instanceof Array&&(n=t,t=void 0),!0===n&&(n=i instanceof Array?i:null,i=!0);var a=[];return each(function(e){e.disabled||n&&e.$except(n)||!1!==e.$valid||e.$valid_disabled||a.push(e)},r(t)),i&&e.state(a,1,1),a},evaluate:function(e,t,r){var n="eval"+t,i=temp[n],a=null;return a=r?e:g(e),i?i.call(a,a,e):(-1===t.indexOf("return")&&(t="return "+t),i=new Function("value","path",t),temp[n]=i,i.call(a,a,e))},exec:w,exec2:function(e,t){var r=!0===e;return function(n,i,a,o){r?w(t,e,n,i,a,o):w(e,n,i,a,o)}},extend:function(t,n,i){if(t=r(t)){var a=g(t);null==a&&(a={}),$(t,e.extend(a,n),i)}return this},format:function(t,r,n){if(e.isFunction(t))return!0===r?p.unshift(t):p.push(t),this;var i=p;if(i&&i.length)for(var a=0,o=i.length;a<o;a++){var u=i[a].call(M,r,t,n);void 0!==u&&(t=u)}return t},get:g,inc:function t(r,n,i){if(r instanceof Array){for(var a=0;a<r.length;a++)t(r[a],n,i);return this}if(!r)return this;var o=g(r);return o?e.isNumber(o)||(o=parseFloat(o),isNaN(o)&&(o=0)):o=0,$(r,o+=n,i),this},invalid:function(e,t){return(e=r(e))&&(a.componenter.com_dirty(e,!1,t,!0),a.componenter.com_valid(e,!1,t)),W},make:function(e,t,r){switch(typeof e){case"function":t=e,e={};break;case"string":var n=e,i=!0;return null==(e=g(n))&&(i=!1,e={}),t.call(e,e,n,function(t,r){$(e,t,r)}),!i||void 0!==r&&!0!==r?a.ready?m(n,e):$(n,e,!0):y(n,!0),e}return t.call(e,e,""),e},modify:function t(r,n,i){return r&&"object"==typeof r?Object.keys(r).forEach(function(e){t(e,r[e],n)}):(e.isFunction(n)&&(n=n(g(r))),$(r,n,i),i?e.setTimeout(_,i+5,r):_(r)),this},modified:function(e){var t=[];return each(function(e){e.disabled||e.$dirty_disabled||!1===e.$dirty&&t.push(e.path)},r(e)),t},parser:j,paths:v,push:x,reset:A,remap:function(e,t){var r=e.replace("--\x3e","->").indexOf("->");-1!==r&&(t=t[e.substring(0,r).trim()],e=e.substring(r+3).trim()),$(e,t)},rewrite:function(e,t,n){return(e=r(e))&&(o=e,m(e,t),u.emitwatch(e,t,n)),this},set:m,set2:function(e,t,r){if(null!=t){var n="++"+t;if(v[n])return v[n](e,r,t);for(var a=f(t),o=[],u=0;u<a.length-1;u++){var s=a[u],l=a[u+1]&&i.test(a[u+1])?"[]":"{}",d="w"+("["===s.substring(0,1)?"":".")+s;o.push("if(typeof("+d+")!=='object'||"+d+"==null)"+d+"="+l)}var c=a[a.length-1];"["!==c.substring(0,1)&&(c="."+c);var h=new Function("w","a","b",o.join(";")+";w"+c+"=a;return a");return v[n]=h,h(e,r,t),e}},setx:$,skipInc:function(){for(var e=0;e<arguments.length;e++)for(var t=arguments[e].split(","),r=0,n=t.length;r<n;r++){var i=t[r].trim();b[i]?b[i]++:b[i]=1}},skipDec:function(e){return!(b[e]&&--b[e]<=0&&(delete b[e],1))},update:y,used:function(e){return each(function(e){!e.disabled&&e.used()},e),this},wait:function(e,t,r,n){var i=(1e4*Math.random()>>0).toString(16),a=n>0?i+"_timeout":0;if("number"==typeof t){var o=r;r=t,t=o}var u="string"==typeof e,s=!1;u?g(e)&&(s=!0):e()&&(s=!0),s?t(null,function(i){setTimeout(function(){WAIT(e,t,r,n)},i||1)}):(a&&(C[a]=setTimeout(function(){clearInterval(C[i]),delete C[a],delete C[i],t(new Error("Timeout."))},n)),C[i]=setInterval(function(){if(u){if(null==g(e))return}else if(!e())return;clearInterval(C[i]),delete C[i],a&&(clearTimeout(C[a]),delete C[a]),t&&t(null,function(n){setTimeout(function(){WAIT(e,t,r)},n||1)})},r||500))}}}});
//# sourceMappingURL=../sourcemaps/views/storing.js.map
