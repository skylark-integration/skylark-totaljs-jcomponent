/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["../langx","../utils/storage","../binding/pathmaker"],function(t,e,r){var n={sort:1,reverse:1,splice:1,slice:1,pop:1,unshift:1,shift:1,push:1},i=/\[\d+\]$/;return function(a){var o="",s=a.eventer,u=a.binding,d=a.cache,l=a.option("store");function c(t){for(var e=t.split("."),r=[],n=[],i=0;i<e.length;i++){var a=e[i],o=a.indexOf("[");if(-1===o)if(-1===a.indexOf("-"))n.push(a),r.push(n.join("."));else{var s=n.splice(n.length-1);n.push(s+"['"+a+"']"),r.push(n.join("."))}else-1===a.indexOf("-")?(n.push(a.substring(0,o)),r.push(n.join(".")),n.splice(n.length-1),n.push(a),r.push(n.join("."))):(n.push("['"+a.substring(0,o)+"']"),r.push(n.join("")),n.push(a.substring(o)),r.push(n.join("")))}return r}var f={},v={},h=[],p={};function b(t,e){if(null!=t){37===t.charCodeAt(0)&&(t="jctmp."+t.substring(1));var r="="+t;if(f[r])return f[r](e||l.data);if(-1===t.indexOf("?")){for(var n=c(t),i=[],a=0,o=n.length-1;a<o;a++){var s=n[a];"["!==s.substring(0,1)&&(s="."+s),i.push("if(!w"+s+")return")}var u=n[n.length-1];"["!==u.substring(0,1)&&(u="."+u);var d=new Function("w",i.join(";")+";return w"+u);return f[r]=d,d(e||l.data)}}}function g(t,e,r){if(null!=t){var n="+"+t;if(f[n])return f[n](l.data,e,t,u.binders,u.binderbind,r);if(-1===t.indexOf("?")){for(var a=c(t),o=[],s=[],d=0;d<a.length-1;d++){var v=a[d],h=a[d+1]&&i.test(a[d+1])?"[]":"{}",p="w"+("["===v.substring(0,1)?"":".")+v;o.push("if(typeof("+p+")!=='object'||"+p+"==null)"+p+"="+h)}for(d=0;d<a.length-1;d++)v=a[d],s.push("binders['"+v+"']&&binderbind('"+v+"','"+t+"',$ticks)");var b=a[a.length-1];s.push("binders['"+b+"']&&binderbind('"+b+"','"+t+"',$ticks)"),s.push("binders['!"+b+"']&&binderbind('!"+b+"','"+t+"',$ticks)"),"["!==b.substring(0,1)&&(b="."+b);var g=new Function("w","a","b","binders","binderbind","nobind","var $ticks=Math.random().toString().substring(2,8);if(!nobind){"+o.join(";")+";var v=typeof(a)=='function'?a(MAIN.compiler.get(b)):a;w"+b+"=v}"+s.join(";")+";return a");return f[n]=g,g(l.data,e,t,u.binders,u.binderbind,r),this}t=""}}function $(t,e,n){if(t instanceof Array){for(var i=0;i<t.length;i++)$(t[i],e,n);return this}if(!(t=r(t)))return this;if(33===t.charCodeAt(0)&&(t=t.substring(1)),43===t.charCodeAt(0))return m(t=t.substring(1),e,n);if(!t)return this;var u="object"==typeof e&&!(e instanceof Array)&&null!=e,l=!0===n;if(l&&(n=1),o=t,g(t,e),u)return y(t,l,n,!0);var c=b(t),f=[];void 0===n&&(n=1);for(var v=a.componenter.components,h=(i=0,v.length);i<h;i++){var p=v[i];p&&!p.disabled&&!p.$removed&&p.$loaded&&p.path&&p.$compare(t)&&(p.setter&&(p.path===t?p.setter&&(p.setterX(c,t,n),p.$interaction(n)):p.setter&&(p.setterX(b(p.path),t,n),p.$interaction(n))),p.$ready||(p.$ready=!0),3!==n&&p.state&&f.push(p),l?(p.$dirty_disabled||(p.$dirty=!0),p.$valid_disabled||(p.$valid=!0,p.$validate=!1,p.validate&&(p.$valid=p.validate(c),p.$interaction(102))),findControl2(p)):p.validate&&!p.$valid_disabled&&p.valid(p.validate(c),!0))}for(l&&d.clear("dirty","valid"),i=0,h=f.length;i<h;i++)f[i].stateX(n,5);return s.emitwatch(t,c,n),this}function y(t,e,n,i){if(t instanceof Array){for(var u=0;u<t.length;u++)y(l,t[u],e,n);return this}if(!(t=r(t)))return this;if(33===t.charCodeAt(0)&&(t=t.substring(1)),!(t=t.replaceWildcard()))return this;i||b(t,b(t));var c=[];void 0===n&&(n=1),o=t;for(var f=a.componenter.components,v=(u=0,f.length);u<v;u++){var h=f[u];if(h&&!h.disabled&&!h.$removed&&h.$loaded&&h.path&&h.$compare(t)){var p=h.get();h.setter&&(h.$skip=!1,h.setterX(p,t,n),h.$interaction(n)),h.$ready||(h.$ready=!0),!0===e?(h.$dirty_disabled||(h.$dirty=!0,h.$interaction(101)),h.$valid_disabled||(h.$valid=!0,h.$validate=!1,h.validate&&(h.$valid=h.validate(p),h.$interaction(102))),findControl2(h)):h.validate&&!h.$valid_disabled&&h.valid(h.validate(p),!0),h.state&&c.push(h)}}for(e&&d.clear("dirty","valid"),u=0,v=c.length;u<v;u++)c[u].stateX(1,4);return s.emitwatch(t,b(t),n),this}function m(t,e,r){if(t instanceof Array){for(var n=0;n<t.length;n++)m(t[n],e,r);return this}var i=b(t),a=!1;i instanceof Array||(i=[],a=!0);var s=!0;return o=t,e instanceof Array?e.length?i.push.apply(i,e):s=!1:i.push(e),a?$(t,i,r):s&&y(t,void 0,r),this}function x(t,e){return null==e&&(e=!0),!a.componenter.com_dirty(t,!e)}function _(e){var r,n=[],i=1,a=!1,o=this;!0===e&&(a=!0,e=arguments[1],i=2),e=e.env();for(var s=i;s<arguments.length;s++)n.push(arguments[s]);var u=e.charCodeAt(0);if(35===u)return r=e.substring(1),a?!events[r]&&exechelper(o,e,n):EMIT.call(o,r,n[0],n[1],n[2],n[3],n[4]),EXEC;var d=0;if(64===u){var l=e.indexOf(".");if(r=e.substring(1,l),f=plugins.find(r)){var c=f[e.substring(l+1)];t.isFunction(c)&&(c.apply(o===Window?f:o,n),d=1)}return a&&!d&&exechelper(o,e,n),EXEC}if(-1!==(l=e.indexOf("/"))){r=e.substring(0,l);var f=plugins.find(r);return c=e.substring(l+1),f&&t.isFunction(f[c])&&(f[c].apply(o===W?f:o,n),d=1),a&&!d&&exechelper(o,e,n),EXEC}return c=b(e),t.isFunction(c)&&(c.apply(o,n),d=1),a&&!d&&exechelper(o,e,n),_}function w(t,e,n){if(e>0)return setTimeout(function(){w(t)},e),this;t=r(t).replaceWildcard();for(var i=[],o=a.componenter.components,s=0,u=o.length;s<u;s++){var l=o[s];l&&!l.$removed&&!l.disabled&&l.$loaded&&l.path&&l.$compare(t)&&(l.state&&i.push(l),n&&n._id!==l._id||(findControl2(l),l.$dirty_disabled||(l.$dirty=!0,l.$interaction(101)),l.$valid_disabled||(l.$valid=!0,l.$validate=!1,l.validate&&(l.$valid=l.validate(l.get()),l.$interaction(102)))))}return d.clear("valid","dirty"),state(i,1,3),this}function A(e,r,n){if(t.isFunction(e))return!0===r?$parser.unshift(e):$parser.push(e),this;var i=$parser;if(i&&i.length)for(var a=0,o=i.length;a<o;a++)e=i[a].call(this,r,e,n);return e}return $parser=[],nmCache={},temp={},A(function(e,r,n){switch(n){case"number":case"currency":case"float":var i=+(t.isString(r)?r.trimAll().replace(REGCOMMA,"."):r);return isNaN(i)?null:i;case"date":case"datetime":return r?r instanceof Date?r:(r=r.parseDate())&&r.getTime()?r:null:null}return r}),{bind:function t(e){if(e instanceof Array){for(var n=0;n<e.length;n++)t(e[n]);return this}if(!(e=r(e)))return this;33===e.charCodeAt(0)&&(e=e.substring(1)),(e=e.replaceWildcard())&&g(e,b(e),!0)},cachePath:function(t,r,n){var i="$jcpath";if(WATCH(t,function(n,a){var o=e(i);o?o[t]=a:(o={})[t]=a,e(i,o,r)}),void 0===n||n){var a=e(i);a&&void 0!==a[t]&&a[t]!==b(t)&&$(t,a[t],!0)}return this},can:function(t,e){return t=r(t),!a.componenter.com_dirty(t,e)&&a.componenter.com_valid(t,e)},change:x,changed:function(t){return!a.componenter.com_dirty(t)},create:function(e){var r,i=!1;if(t.isString(e)){if(proxy[e])return proxy[e];i=!0,r=function(t){var r=e+(t?"."+t:"");o!==r?setTimeout(function(){o===r?o="":(notify(r),w(r))},MD.delaybinder):o=""}}else r=e;var a=!1,s=e&&b(e)||{},u={get:function(t,e,r){try{return new Proxy(t[e],u)}catch(n){return Reflect.get(t,e,r)}},defineProperty:function(t,e,n){return!a&&r(e,n),Reflect.defineProperty(t,e,n)},deleteProperty:function(t,e){return!a&&r(e),Reflect.deleteProperty(t,e)},apply:function(t,e,i){if(n[t.name]){a=!0;var o=Reflect.apply(t,e,i);return r("",i[0]),a=!1,o}return Reflect.apply(t,e,i)}},d=new Proxy(s,u);return i?(o=e,null==b(e)&&$(e,s,!0),proxy[e]=d):d},default:function e(n,i,o,s){if(i>0)return setTimeout(function(){e(n,0,o,s)},i),this;"boolean"==typeof o&&(s=o,o=null),void 0===s&&(s=!0);var u=(n=r(n.replaceWildcard())).replace(/\.\*$/,""),l=v["#"+t.hashCode(u)];l&&g(u,l());for(var c=[],f=a.componenter.components,h=0,p=f.length;h<p;h++){var b=f[h];if(b&&!b.$removed&&!b.disabled&&b.$loaded&&b.path&&b.$compare(n)&&(b.state&&c.push(b),!o||o._id===b._id)){if(b.$default&&b.set(b.$default(),3),!s)return;findControl2(b),b.$dirty_disabled||(b.$dirty=!0),b.$valid_disabled||(b.$valid=!0,b.$validate=!1,b.validate&&(b.$valid=b.validate(b.get()),b.$interaction(102)))}}return s&&(d.clearPageData("valid","dirty"),t.state(c,3,3)),this},disabled:function(t,e){return t=r(t),a.componenter.com_dirty(t,e)||!a.componenter.com_valid(t,e)},errors:function(e,n,i){e instanceof Array&&(n=e,e=void 0),!0===n&&(n=i instanceof Array?i:null,i=!0);var a=[];return each(function(t){t.disabled||n&&t.$except(n)||!1!==t.$valid||t.$valid_disabled||a.push(t)},r(e)),i&&t.state(a,1,1),a},evaluate:function(t,e,r){var n="eval"+e,i=temp[n],a=null;return a=r?t:b(t),i?i.call(a,a,t):(-1===e.indexOf("return")&&(e="return "+e),i=new Function("value","path",e),temp[n]=i,i.call(a,a,t))},exec:_,exec2:function(t,e){var r=!0===t;return function(n,i,a,o){r?_(e,t,n,i,a,o):_(t,n,i,a,o)}},extend:function(e,n,i){if(e=r(e)){var a=b(e);null==a&&(a={}),$(e,t.extend(a,n),i)}return this},format:function(e,r,n){if(t.isFunction(e))return!0===r?h.unshift(e):h.push(e),this;var i=h;if(i&&i.length)for(var a=0,o=i.length;a<o;a++){var s=i[a].call(M,r,e,n);void 0!==s&&(e=s)}return e},get:b,inc:function e(r,n,i){if(r instanceof Array){for(var a=0;a<r.length;a++)e(r[a],n,i);return this}if(!r)return this;var o=b(r);return o?t.isNumber(o)||(o=parseFloat(o),isNaN(o)&&(o=0)):o=0,$(r,o+=n,i),this},invalid:function(t,e){return(t=r(t))&&(a.componenter.com_dirty(t,!1,e,!0),a.componenter.com_valid(t,!1,e)),W},make:function(t,e,r){switch(typeof t){case"function":e=t,t={};break;case"string":var n=t,i=!0;return null==(t=b(n))&&(i=!1,t={}),e.call(t,t,n,function(e,r){$(t,e,r)}),!i||void 0!==r&&!0!==r?a.ready?g(n,t):$(n,t,!0):y(n,!0),t}return e.call(t,t,""),t},modify:function e(r,n,i){return r&&"object"==typeof r?Object.keys(r).forEach(function(t){e(t,r[t],n)}):(t.isFunction(n)&&(n=n(b(r))),$(r,n,i),i?t.setTimeout(x,i+5,r):x(r)),this},modified:function(t){var e=[];return each(function(t){t.disabled||t.$dirty_disabled||!1===t.$dirty&&e.push(t.path)},r(t)),e},parser:A,paths:f,push:m,reset:w,rewrite:function(t,e,n){return(t=r(t))&&(o=t,g(t,e),s.emitwatch(t,e,n)),this},set:g,set2:function(t,e,r){if(null!=e){var n="++"+e;if(f[n])return f[n](t,r,e);for(var a=c(e),o=[],s=0;s<a.length-1;s++){var u=a[s],d=a[s+1]&&i.test(a[s+1])?"[]":"{}",l="w"+("["===u.substring(0,1)?"":".")+u;o.push("if(typeof("+l+")!=='object'||"+l+"==null)"+l+"="+d)}var v=a[a.length-1];"["!==v.substring(0,1)&&(v="."+v);var h=new Function("w","a","b",o.join(";")+";w"+v+"=a;return a");return f[n]=h,h(t,r,e),t}},setx:$,skipInc:function(){for(var t=0;t<arguments.length;t++)for(var e=arguments[t].split(","),r=0,n=e.length;r<n;r++){var i=e[r].trim();p[i]?p[i]++:p[i]=1}},skipDec:function(t){return!(p[t]&&--p[t]<=0&&(delete p[t],1))},update:y,used:function(t){return each(function(t){!t.disabled&&t.used()},t),this}}}});
//# sourceMappingURL=../sourcemaps/views/storing.js.map
