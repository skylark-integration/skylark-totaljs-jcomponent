/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["../langx","../utils/query","../utils/domx","../utils/logs","../components/registry","../components/configs","../components/versions"],function(e,t,n,i,r,o,a){var c=e.statics,l=i.warn,s={fallback:"https://cdn.componentator.com/j-{0}.html",fallbackcache:"",importcache:"session",version:""},m={$:0};return function(i){var f=i.helper,u=i.eventer,p=i.storing,h=i.scoper,d=i.binding,g=i.cache,v=i.http,$=i.componenter;function b(){g.clear("find")}setInterval(function(){temp={}},3e5),setInterval(function(){b()},3e5);var k=0,y=[],N=[],O={},C=[],T={},w={is:!1,recompile:!1},x=!1,j=[];function _(){k?setTimeout(_,1e3):e.setTimeout2("$fallback",function(){j.splice(0).wait(function(e,t){r[e]?t():(l("Downloading: "+e),v.importCache(s.fallback.format(e),s.fallbackcache,t))},3)},100)}function E(){var e=y.shift();if(e)e();else if(i.ready&&(w.is=!1),s.fallback&&m.$&&!k){for(var t=Object.keys(m),n=0;n<t.length;n++)"$"!==t[n]&&1===m[t[n]]&&(j.push(t[n].toLowerCase()),m[t[n]]=2);m.$=0,j.length&&_()}}function P(t,n,r,o){t.importing?i.storing.wait(function(){return!0!==t.importing},function(){n(r,o)}):t.dependencies&&t.dependencies.length?(t.importing=!0,t.dependencies.wait(function(t,n){e.isFunction(t)?t(n):v.import((-1===t.indexOf("<")?"once ":"")+t,n)},function(){t.importing=!1,n(r,o)},3)):setTimeout(function(e,t,n){e(t,n)},5,n,r,o)}function S(e,t){var i,r=e[0].tagName;n.inputable(r)?(t.$input=!0,i=t.element):i=e,f.findControl2(t,i),t.released&&t.released(t.$released),$.components.push(t),N.push(t),"BODY"!==r&&f.canCompile(e[0])&&L(e),z()}function I(u,p,g,b){var y=t(p),N=u.split(/_{2,}/);if(N.length?u=(N=N.trim(!0))[0]:N=null,has=!0,c["$ST_"+u])n.remove(y);else{for(var C=[],w=u.split(","),x=0;x<w.length;x++){var j=!1;if(-1!==(u=w[x].trim()).indexOf("|")){for(var _=u.split("|"),E=0;E<_.length;E++){var I=_[E].trim();if(I&&r[I]){u=I,j=!0;break}}j||(u=_[0].trim())}var L=!1;if("lazy "===u.substring(0,5).toLowerCase()&&(u=u.substring(5),L=!0),!j&&-1===u.lastIndexOf("@")){var z=a.get(u);z?u+="@"+z:s.version&&(u+="@"+s.version)}var D=r[u],F=null;if(!L||!u||1!==(F=$.checkLazy(u)).state)if(D){1===m[u]&&(m.$--,delete m[u]);for(var Y=new f.Component(D.name,i),q=p.parentNode;;){if(q.$com){var A=q.$com;Y.owner=A,A.$children?A.$children++:A.$children=1;break}if("BODY"===q.nodeName)break;if(null==(q=q.parentNode))break}Y.global=D.shared,Y.element=y,Y.dom=p;var B=f.attrcom(y,"path")||(N?"null"===N[1]?"":N[1]:"")||Y._id;"%"===B.substring(0,1)&&(Y.$noscope=!0),Y.setPath(d.pathmaker(B,!0),1),Y.config={},D.config&&Y.reconfigure(D.config,NOOP);var H=f.attrcom(y,"config")||(N?"null"===N[2]?"":N[2]:"");for(H&&Y.reconfigure(H,NOOP),Y.$init||(Y.$init=f.attrcom(y,"init")||null),Y.type||(Y.type=f.attrcom(y,"type")||""),Y.id||(Y.id=f.attrcom(y,"id")||Y._id),Y.siblings=w.length>1,Y.$lazy=F,E=0;E<o.length;E++){var G=o[E];G.fn(Y)&&Y.reconfigure(G.config,NOOP)}T.com=Y,D.declaration.call(Y,Y,Y.config),T.com=null,N[3]&&y.attrd("jc-value",N[3]),Y.init&&!c[u]&&(c[u]=!0,Y.init()),p.$com=Y,Y.$noscope||(Y.$noscope="true"===f.attrcom(y,"noscope"));var R=Y.path?Y.path.charCodeAt(0):0;if(!Y.$noscope&&b.length&&!Y.$pp){var U=h.initscopes(b);Y.path&&33!==R&&35!==R?Y.setPath("?"===Y.path?U.path:-1===Y.path.indexOf("?")?U.path+"."+Y.path:Y.path.replace(/\?/g,U.path),2):(Y.$$path=[],Y.path=""),Y.scope=U,Y.pathscope=U.path}C.push(Y);var J=f.attrcom(y,"template")||Y.template;if(J&&(Y.template=J),"true"===f.attrcom(y,"released")&&(Y.$released=!0),f.attrcom(y,"url"))l('Components: You have to use "data-jc-template" attribute instead of "data-jc-url" for the component: {0}[{1}].'.format(Y.name,Y.path));else if(e.isString(J)){var K=function(t){Y.prerender&&(t=Y.prerender(t)),P(D,function(n,i){if(e.isFunction(n.make)){var r=T.com;T.com=n,n.make(t),T.com=r}S(i,n)},Y,y)},M=J.substring(0,1);if("."===M||"#"===M||"["===M){K(t(J).html());continue}var Q="TE"+HASH(J),V=c[Q];if(V){K(V);continue}t.get(f.makeurl(J),function(e){c[Q]=e,K(e)})}else if(e.isString(Y.make)){if(-1!==Y.make.indexOf("<")){P(D,function(e,t){e.prerender&&(e.make=e.prerender(e.make)),t.html(e.make),S(t,e)},Y,y);continue}t.get(makeurl(Y.make),function(e){P(D,function(t,n){t.prerender&&(e=t.prerender(e)),n.html(e),S(n,t)},Y,y)})}else D.dependencies?P(D,function(e,t){if(e.make){var n=T.com;T.com=e,e.make(),T.com=n}S(t,e)},Y,y):setTimeout(function(e,t,n){if(n.make){var i=T.com;T.com=n,n.make(),T.com=i}e(t,n)},5,S,y,Y)}else{m[u]||(m[u]=1,m.$++);var W=f.attrcom(y,"import");if(!W){!c["$NE_"+u]&&(c["$NE_"+u]=!0);continue}if(1===O[W])continue;if(2===O[W]){!c["$NE_"+u]&&(c["$NE_"+u]=!0);continue}O[W]=1,k++,v.import(W,function(){k--,O[W]=2})}}C.length>0&&(y.$com=C.length>1?C:C[0])}}function L(r,o){var a=this;if(w.is)w.recompile=!0;else{var l=[];if(l.length)for(;;){var m=l.shift();if(!m)break;m()}if(w.is=!0,function(){var r=[],o=0;if(f.findUrl(i.elm()).each(function(){var e=this,n=t(e);if(!e.$downloaded){e.$downloaded=1;var i=f.attrcom(n,"url"),o="once "===i.substring(0,5).toLowerCase();if("!"===i.substring(0,1)||o){if(i=o?i.substring(5):i.substring(1),c[i])return;c[i]=2}var a={};a.url=i,a.element=n,a.callback=f.attrcom(n,"init"),a.path=f.attrcom(n,"path"),a.toggle=(f.attrcom(n,"class")||"").split(" "),a.expire=f.attrcom(n,"cache")||s.importcache,r.push(a)}}),r.length){var a=!1;k++,e.async(r,function(t,i){var r=f.makeurl(t.url);v.ajaxCache("GET "+t.url,null,function(l){if(r="$import"+r,T.element=t.element[0],(l=c[r]?n.removescripts(l):n.importscripts(importstyles(l)))&&f.canCompile(l)&&(a=!0),t.element.html(l),c[r]=!0,t.toggle.length&&t.toggle[0]&&C.push(t),t.callback&&!f.attrcom(t.element)){var s=p.get(t.callback);e.isFunction(s)&&s(t.element)}T.element=null,o++,i()},t.expire)},function(){k--,$.clean(),o&&a&&L()})}}(),y.length)y.push(function(){L(a)});else{if(function e(n,r,o,a){if((n=n?t(n)[0]:i.elm())&&!f.nocompile(n)){if((null==o||0===o)&&(a=[],n!==i.elm())){var c=f.scope(n);c&&a.push(c)}var l=null,s=!!n&&f.released(n),m=null;f.attrscope(n)&&a.push(n),n.$jcbind||(l=f.attrbind(n))&&(m||(m=[]),m.push({el:n,b:l}));var u=f.attrcom(n);n.$com||null==u||r(u,n,0,a);var p=n.childNodes,h=[];void 0===o?o=0:o++;for(var g=0,v=p.length;g<v;g++){var $=p[g];if($){if(!$.tagName)continue;if(f.nocompile($))continue;void 0===$.$com&&null!=(u=f.attrcom($))&&(s&&f.released($,"true"),r(u||"",$,o,a)),$.$jcbind||(l=f.attrbind($))&&($.$jcbind=1,!m&&(m=[]),m.push({el:$,b:l})),f.nocompile($)||$.childNodes.length&&"SCRIPT"!==$.tagName&&f.canCompile($)&&-1===h.indexOf($)&&h.push($)}}for(g=0,v=h.length;g<v;g++)($=h[g])&&e($,r,o,a&&a.length?a:[]);if(m)for(g=0;g<m.length;g++){var b=m[g];b.el.$jcbind=d.parse(b.el,b.b,a)}}}(r,I),d.rebindbinder(),w.is=!1,void 0!==r||!C.length)return E();e.async(C,function(e,t){for(var n=0,i=e.toggle.length;n<i;n++)e.element.tclass(e.toggle[n]);t()},E)}}}function z(){e.setTimeout2("$ready",function(){i.refresh(),function e(){var t=N.pop();void 0===t?!i.ready&&L():(t.$removed||$.prepare(t),e())}();var n=$.components.length;if(t(document).trigger("components",[n]),x||(x=!0,$.clean(),u.emit("init"),u.emit("ready")),e.setTimeout2("$initcleaner",function(){$.clean();for(var e=$.autofill.splice(0),n=0;n<e.length;n++){var i=e[n];!i.$default&&f.findControl(i.element[0],function(e){var n=t(e).val();if(n){var r=i.parser(n);r&&i.get()!==r&&(i.dirty(!1,!0),i.set(r,0))}return!0})}},1e3),w.is=!1,w.recompile&&(w.recompile=!1,L()),i.ready){for(var r=i.ready,o=0,a=r.length;o<a;o++)r[o](n);i.ready=void 0,L(),setTimeout(L,3e3),setTimeout(L,6e3),setTimeout(L,9e3)}},100)}return e.mixin(w,{compile:L,request:z})}});
//# sourceMappingURL=../sourcemaps/views/compiler.js.map
