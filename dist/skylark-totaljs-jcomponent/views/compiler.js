/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["../langx","../utils/query","../utils/domx","../utils/http","../components/registry","../components/configs","../components/versions","../plugins"],function(e,t,n,i,r,o,a,c){var l=e.statics,s={fallback:"https://cdn.componentator.com/j-{0}.html",fallbackcache:"",importcache:"session",version:""},m={$:0};function u(){clear("find")}return setInterval(function(){temp={},paths={}},3e5),setInterval(function(){u()},3e5),function(c){var u=c.helper,p=c.eventer,f=c.storing,h=c.scoper,g=c.binding,d=c.componenter,v=!1;recompile=!1,importing=0,pending=[],initing=[],imports={},toggles=[],ready=[],cache={current:{}};var $=!1,b=[];function k(){importing?setTimeout(k,1e3):e.setTimeout2("$fallback",function(){b.splice(0).wait(function(e,t){r[e]?t():(warn("Downloading: "+e),i.importCache(s.fallback.format(e),s.fallbackcache,t))},3)},100)}function y(){var e=pending.shift();if(e)e();else if(ready&&(v=!1),s.fallback&&m.$&&!importing){for(var t=Object.keys(m),n=0;n<t.length;n++)"$"!==t[n]&&1===m[t[n]]&&(b.push(t[n].toLowerCase()),m[t[n]]=2);m.$=0,b.length&&k()}}function N(t,n,r,o){t.importing?e.wait(function(){return!0!==t.importing},function(){n(r,o)}):t.dependencies&&t.dependencies.length?(t.importing=!0,t.dependencies.wait(function(t,n){e.isFunction(t)?t(n):i.import2((-1===t.indexOf("<")?"once ":"")+t,n)},function(){t.importing=!1,n(r,o)},3)):setTimeout(function(e,t,n){e(t,n)},5,n,r,o)}function O(e,t){var i,r=e[0].tagName;n.inputable(r)?(t.$input=!0,i=t.element):i=e,u.findControl2(t,i),t.released&&t.released(t.$released),d.components.push(t),initing.push(t),"BODY"!==r&&u.canCompile(e[0])&&w(e),T()}function C(p,f,v,$){var b=t(f),k=p.split(/_{2,}/);if(k.length?p=(k=k.trim(!0))[0]:k=null,has=!0,l["$ST_"+p])n.remove(b);else{for(var y=[],C=p.split(","),w=0;w<C.length;w++){var T=!1;if(-1!==(p=C[w].trim()).indexOf("|")){for(var x=p.split("|"),j=0;j<x.length;j++){var _=x[j].trim();if(_&&r[_]){p=_,T=!0;break}}T||(p=x[0].trim())}var E=!1;if("lazy "===p.substring(0,5).toLowerCase()&&(p=p.substring(5),E=!0),!T&&-1===p.lastIndexOf("@")){var P=a.get(p);P?p+="@"+P:s.version&&(p+="@"+s.version)}var S=r[p],I=null;if(!E||!p||1!==(I=d.checkLazy(p)).state)if(S){1===m[p]&&(m.$--,delete m[p]);for(var L=new u.Component(S.name,c),z=f.parentNode;;){if(z.$com){var D=z.$com;L.owner=D,D.$children?D.$children++:D.$children=1;break}if("BODY"===z.nodeName)break;if(null==(z=z.parentNode))break}L.global=S.shared,L.element=b,L.dom=f;var F=u.attrcom(b,"path")||(k?"null"===k[1]?"":k[1]:"")||L._id;"%"===F.substring(0,1)&&(L.$noscope=!0),L.setPath(g.pathmaker(F,!0),1),L.config={},S.config&&L.reconfigure(S.config,NOOP);var Y=u.attrcom(b,"config")||(k?"null"===k[2]?"":k[2]:"");for(Y&&L.reconfigure(Y,NOOP),L.$init||(L.$init=u.attrcom(b,"init")||null),L.type||(L.type=u.attrcom(b,"type")||""),L.id||(L.id=u.attrcom(b,"id")||L._id),L.siblings=C.length>1,L.$lazy=I,j=0;j<o.length;j++){var q=o[j];q.fn(L)&&L.reconfigure(q.config,NOOP)}cache.current.com=L,S.declaration.call(L,L,L.config),cache.current.com=null,k[3]&&b.attrd("jc-value",k[3]),L.init&&!l[p]&&(l[p]=!0,L.init()),f.$com=L,L.$noscope||(L.$noscope="true"===u.attrcom(b,"noscope"));var A=L.path?L.path.charCodeAt(0):0;if(!L.$noscope&&$.length&&!L.$pp){var B=h.initscopes($);L.path&&33!==A&&35!==A?L.setPath("?"===L.path?B.path:-1===L.path.indexOf("?")?B.path+"."+L.path:L.path.replace(/\?/g,B.path),2):(L.$$path=[],L.path=""),L.scope=B,L.pathscope=B.path}y.push(L);var H=u.attrcom(b,"template")||L.template;if(H&&(L.template=H),"true"===u.attrcom(b,"released")&&(L.$released=!0),u.attrcom(b,"url"))warn('Components: You have to use "data-jc-template" attribute instead of "data-jc-url" for the component: {0}[{1}].'.format(L.name,L.path));else if(e.isString(H)){var G=function(t){L.prerender&&(t=L.prerender(t)),N(S,function(n,i){if(e.isFunction(n.make)){var r=cache.current.com;cache.current.com=n,n.make(t),cache.current.com=r}O(i,n)},L,b)},R=H.substring(0,1);if("."===R||"#"===R||"["===R){G(t(H).html());continue}var U="TE"+HASH(H),J=l[U];if(J){G(J);continue}t.get(u.makeurl(H),function(e){l[U]=e,G(e)})}else if(e.isString(L.make)){if(-1!==L.make.indexOf("<")){N(S,function(e,t){e.prerender&&(e.make=e.prerender(e.make)),t.html(e.make),O(t,e)},L,b);continue}t.get(makeurl(L.make),function(e){N(S,function(t,n){t.prerender&&(e=t.prerender(e)),n.html(e),O(n,t)},L,b)})}else S.dependencies?N(S,function(e,t){if(e.make){var n=cache.current.com;cache.current.com=e,e.make(),cache.current.com=n}O(t,e)},L,b):setTimeout(function(e,t,n){if(n.make){var i=cache.current.com;cache.current.com=n,n.make(),cache.current.com=i}e(t,n)},5,O,b,L)}else{m[p]||(m[p]=1,m.$++);var K=u.attrcom(b,"import");if(!K){!l["$NE_"+p]&&(l["$NE_"+p]=!0);continue}if(1===imports[K])continue;if(2===imports[K]){!l["$NE_"+p]&&(l["$NE_"+p]=!0);continue}imports[K]=1,importing++,i.import(K,function(){importing--,imports[K]=2})}}y.length>0&&(b.$com=y.length>1?y:y[0])}}function w(r,o){var a=this;if(v)recompile=!0;else{var m=[];if(m.length)for(;;){var p=m.shift();if(!p)break;p()}if(v=!0,function(){var r=[],o=0;if(u.findUrl(c.elm()).each(function(){var e=this,n=t(e);if(!e.$downloaded){e.$downloaded=1;var i=u.attrcom(n,"url"),o="once "===i.substring(0,5).toLowerCase();if("!"===i.substring(0,1)||o){if(i=o?i.substring(5):i.substring(1),l[i])return;l[i]=2}var a={};a.url=i,a.element=n,a.callback=u.attrcom(n,"init"),a.path=u.attrcom(n,"path"),a.toggle=(u.attrcom(n,"class")||"").split(" "),a.expire=u.attrcom(n,"cache")||s.importcache,r.push(a)}}),r.length){var a=!1;importing++,e.async(r,function(t,r){var c=u.makeurl(t.url);i.ajaxCache("GET "+t.url,null,function(i){if(c="$import"+c,cache.current.element=t.element[0],(i=l[c]?n.removescripts(i):n.importscripts(importstyles(i)))&&u.canCompile(i)&&(a=!0),t.element.html(i),l[c]=!0,t.toggle.length&&t.toggle[0]&&toggles.push(t),t.callback&&!u.attrcom(t.element)){var s=f.get(t.callback);e.isFunction(s)&&s(t.element)}cache.current.element=null,o++,r()},t.expire)},function(){importing--,d.clean(),o&&a&&w()})}}(),pending.length)pending.push(function(){w(a)});else{if(function e(n,i,r,o){if((n=n?t(n)[0]:c.elm())&&!u.nocompile(n)){if((null==r||0===r)&&(o=[],n!==c.elm())){var a=u.scope(n);a&&scopes.push(a)}var l=null,s=!!n&&u.released(n),m=null;u.scope(n)&&o.push(n),n.$jcbind||(l=u.attrbind(n))&&(m||(m=[]),m.push({el:n,b:l}));var p=u.attrcom(n);n.$com||null==p||i(p,n,0,o);var f=n.childNodes,h=[];void 0===r?r=0:r++;for(var d=0,v=f.length;d<v;d++){var $=f[d];if($){if(!$.tagName)continue;if(u.nocompile($))continue;void 0===$.$com&&null!=(p=u.attrcom($))&&(s&&u.released($,"true"),i(p||"",$,r,o)),$.$jcbind||(l=u.attrbind($))&&($.$jcbind=1,!m&&(m=[]),m.push({el:$,b:l})),u.nocompile($)||$.childNodes.length&&"SCRIPT"!==$.tagName&&u.canCompile($)&&-1===h.indexOf($)&&h.push($)}}for(d=0,v=h.length;d<v;d++)($=h[d])&&e($,i,r,o&&o.length?o:[]);if(m)for(d=0;d<m.length;d++){var b=m[d];b.el.$jcbind=g.parse(b.el,b.b,o)}}}(r,C),g.rebindbinder(),v=!1,void 0!==r||!toggles.length)return y();e.async(toggles,function(e,t){for(var n=0,i=e.toggle.length;n<i;n++)e.element.tclass(e.toggle[n]);t()},y)}}}function T(){e.setTimeout2("$ready",function(){c.refresh(),function e(){var t=initing.pop();void 0===t?!ready&&w():(t.$removed||d.prepare(t),e())}();var n=d.components.length;if(t(document).trigger("components",[n]),$||($=!0,d.clean(),p.emit("init"),p.emit("ready")),e.setTimeout2("$initcleaner",function(){d.clean();for(var e=d.autofill.splice(0),n=0;n<e.length;n++){var i=e[n];!i.$default&&u.findControl(i.element[0],function(e){var n=t(e).val();if(n){var r=i.parser(n);r&&i.get()!==r&&(i.dirty(!1,!0),i.set(r,0))}return!0})}},1e3),v=!1,recompile&&(recompile=!1,w()),ready){for(var i=ready,r=0,o=i.length;r<o;r++)i[r](n);ready=void 0,w(),setTimeout(w,3e3),setTimeout(w,6e3),setTimeout(w,9e3)}},100)}return{compile:w,request:T}}});
//# sourceMappingURL=../sourcemaps/views/compiler.js.map
