/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["skylark-net-http/Xhr","../jc","../langx","../utils/domx","../utils/storage"],function(e,t,r,n,s){var i=/(data-jc|data-jc-url|data-jc-import|data-bind|bind)=|COMPONENT\(/,a=r.statics;return function(t){var o={},u={};function c(t,r){r.url=t;var n=e.request(r.url,r);return(n=n.then(function(){r.success&&r.success.apply(this,arguments)},function(){r.error&&r.error.apply(this,arguments)})).success=n.done,n.error=n.fail,n.complete=n.always,n}function l(e){var t={};return e.split("\n").forEach(function(e){var r=e.indexOf(":");-1!==r&&(t[e.substring(0,r).toLowerCase()]=e.substring(r+1).trim())}),t}function p(e,t,n,i,a){n&&!n.version&&M.$version&&(n.version=M.$version),n&&!n.language&&M.$language&&(n.language=M.$language),n=r.stringify(n);var o=r.hashCode(e+"#"+t.replace(/\//g,"")+n).toString();return s.set(o,i,a)}function f(e,t){var r=[];return encodeURIComponent,r.length?(e+=-1==e.indexOf("?")?"?":"&")+r.join("&"):e}function d(e,s,o,u,c,l){var p,d=(e=e.$env().replace(/<.*?>/,function(e){return p=e.substring(1,e.length-1).trim(),""}).trim()).substring(0,1),h="once "===e.substring(0,5).toLowerCase();if(r.isFunction(o)?(r.isFunction(u)?(l=u,c=!0):r.isFunction(c)&&(l=c,c=!0),u=o,o="body"):r.isFunction(c)&&(l=c,c=!0),p){var m="()"===p.substring(p.length-2);m&&(p=p.substring(0,p.length-2));var b=GET(p);if(m&&r.isFunction(b)){if(b())return void(u&&u(0))}else if(b)return void(u&&u(0))}"//"===e.substring(0,2)&&(e=location.protocol+e);var x=e.lastIndexOf(" ."),y="";if(-1!==x&&(y=e.substring(x).trim().toLowerCase(),e=e.substring(0,x).trim()),"!"===d||h){if(e=h?e.substring(5):e.substring(1),a[e])return u&&(2===a[e]?u(0):r.wait(function(){return 2===a[e]},function(){u(0)})),W;a[e]=1}if(o&&o.setPath&&(o=o.element),o||(o="body"),!y)if(-1!==(x=e.lastIndexOf("?"))){var j=e.lastIndexOf(".",x);-1!==j&&(y=e.substring(j,x).toLowerCase())}else-1!==(x=e.lastIndexOf("."))&&(y=e.substring(x).toLowerCase());var T=document;if(".js"===y){var O=T.createElement("script");return O.type="text/javascript",O.async=!1,O.onload=function(){a[e]=2,u&&u(1),setTimeout(t.compiler.compile,300)},O.src=f(e),T.getElementsByTagName("head")[0].appendChild(O),t.eventer.emit("import",e,$(O)),this}if(".css"===y){var R=T.createElement("link");return R.type="text/css",R.rel="stylesheet",R.href=f(e),T.getElementsByTagName("head")[0].appendChild(R),a[e]=2,u&&setTimeout(u,200,1),t.eventer.emit("import",e,$(R)),this}return r.wait(function(){return!!W.jQuery},function(){a[e]=2;var p="import"+r.hashCode(e),f=function(s,a,f){if(s){e="$import"+e,l&&(s=l(s,f));var d=i.test(s);s=n.importscripts(n.importstyles(s,p)).trim(),o=$(o),s&&(!1===c?o.html(s):o.append(s)),setTimeout(function(){d&&t.compiler.compile(),u&&r.wait(function(){return 0==t.compiler.is},function(){u(1)}),t.eventer.emit("import",e,o)},10)}else u&&u(0)};s?g("GET "+e,null,f,s):v("GET "+e,f)}),W}function v(e,n,s,i){r.isFunction(e)&&(i=s,s=n,n=e,e=location.pathname);var a,p=typeof n,d=EMPTYARRAY;s||"function"!==p&&"string"!==p||(i=s,s=n,n=void 0);var v=e.indexOf(" ");if(-1===v)return W;var g=!1;e=e.replace(/\srepeat/i,function(){return g=!0,""}),g&&(d=[e,n,s,i]);var h=e.substring(0,v).toUpperCase(),m="!"===h.substring(0,1);m&&(h=h.substring(1));var b={};return(a=e.match(/\{.*?\}/g))&&(e=e.replace(a,"").replace(/\s{2,}/g," "),a=new Function("return "+a)(),r.isObject(a)&&(b=a)),e=e.substring(v).trim().$env(),setTimeout(function(){if("GET"===h&&n){var i=r.isString(n)?n:jQuery.param(n,!0);i&&(e+="?"+i)}var a={};a.method=h,a.converters=u.jsonconverter,"GET"!==h&&(r.isString(n)?a.data=n:(a.contentType="application/json; charset=utf-8",a.data=STRINGIFY(n))),a.headers=r.extend(b,u.headers),e.match(/http:\/\/|https:\/\//i)?(a.crossDomain=!0,delete a.headers["X-Requested-With"],m&&(a.xhrFields={withCredentials:!0})):e=e.ROOT();var p=e.match(/\([a-z0-9\-.,]+\)/i);if(p){e=e.replace(p,"").replace(/\s+/g,""),a.url=e,p=p.toString().replace(/\(|\)/g,"").split(",");for(var v=0;v<p.length;v++){var x=o[p[v].trim()];x&&x(a)}}if(a.url||(a.url=e),t.eventer.emit("request",a),!a.cancel){a.type=a.method,delete a.method;var y={};y.url=a.url,y.process=!0,y.error=!1,y.upload=!1,y.method=h,y.data=n,delete a.url,a.success=function(e,r,n){y.response=e,y.status=n.status||999,y.text=r,y.headers=l(n.getAllResponseHeaders()),t.eventer.emit("response",y),y.process&&!y.cancel&&s&&s.call(y,y.response,void 0,y)},a.error=function(e,n){var i=e.status;if(!g||i&&408!==i&&502!==i&&503!==i&&504!==i&&509!==i){y.response=e.responseText,y.status=i||999,y.text=n,y.error=!0,y.headers=l(e.getAllResponseHeaders());var a=y.headers["content-type"];if(a&&-1!==a.indexOf("/json"))try{y.response=PARSE(y.response,u.jsondate)}catch(e){}t.eventer.emit("response",y),!y.cancel&&y.process&&(u.ajaxerrors?s&&s.call(y,y.response,y.status,y):(t.eventer.emit("error",y),r.isFunction(s)&&s.call(y,y.response,y.status,y)))}else setTimeout(function(){d[0]+=" REPEAT",W.AJAX.apply(M,d)},u.delayrepeat)},c(f(y.url),a)}},i||0),this}function g(e,t,n,s,i,a,o){(r.isFunction(t)||r.isString(t)&&r.isString(n)&&!r.isString(s))&&(a=i,i=s,s=n,n=t,t=null),r.isBoolean(i)&&(a=!0===i,i=0);var u=e.indexOf(" ");if(-1===u)return W;var c=e.substring(0,u).toUpperCase(),l=e.substring(u).trim().$env();return setTimeout(function(){var r=a?void 0:p(c,l,t,void 0,s);if(void 0===r)v(e,t,function(e,r){r&&(e=r),p(c,l,t,e,s),n(e,!1)});else{var i=o?STRINGIFY(r):null;if(n(r,!0),!o)return;v(e,t,function(e,r){r&&(e=r),i!==STRINGIFY(e)&&(p(c,l,t,e,s),n(e,!1,!0))})}},i||1),this}return u.ajaxerrors=!1,u.pingdata={},u.baseurl="",u.makeurl=null,u.delayrepeat=2e3,u.jsondate=!0,u.jsonconverter={"text json":function(e){return PARSE(e)}},u.headers={"X-Requested-With":"XMLHttpRequest"},{defaults:u,ajax:v,ajaxCache:g,ajaxCacheReview:function(e,t,r,n,s,i){return g(e,t,r,n,s,i,!0)},configure:function(e,t){return o[e]=t,this},import:function(e,t,n,s,i){return e instanceof Array?(r.isFunction(t)&&(i=s,s=n,n=t,t=null),e.wait(function(e,r){d(e,null,t,r,s,i)},function(){n&&n()})):d(e,null,t,n,s,i),this},importCache:d,makeParams:function(t,n,s){var i,a=location;r.isObject(t)&&(s=n,n=t,t=a.pathname+a.search);var o=t.indexOf("?");-1!==o?(i=M.parseQuery(t.substring(o+1)),t=t.substring(0,o)):i={};for(var u=Object.keys(n),c=0,l=u.length;c<l;c++){var p=u[c];i[p]=n[p]}var f=e.param(i,null==s||!0===s);return t+(f?"?"+f:"")},makeurl:f,ping:function(e,t,r){if(null==navigator.onLine||navigator.onLine){"boolean"==typeof t&&(r=t,t=0);var n=(e=e.$env()).indexOf(" "),s="GET";-1!==n&&(s=e.substring(0,n).toUpperCase(),e=e.substring(n).trim());var i={},a=$langx.Xhr.param(u.pingdata);return a&&(n=e.lastIndexOf("?"),e+=-1===n?"?"+a:"&"+a),i.type=s,i.headers={"x-ping":location.pathname,"x-cookies":navigator.cookieEnabled?"1":"0","x-referrer":document.referrer},i.success=function(e){if(e)try{new Function(e)()}catch(e){}},r&&c(f(e),i),setInterval(function(){c(f(e),i)},t||3e4)}},parseQuery:function(e){if(e||(e=location.search),!e)return{};var t=e.indexOf("?");-1!==t&&(e=e.substring(t+1));for(var r=e.split("&"),n={},s=0,i=r.length;s<i;s++){var a=r[s].split("="),o=a[0],u=decodeURIComponent((a[1]||"").replace(/\+/g,"%20"));n[o]?(n[o]instanceof Array||(n[o]=[n[o]]),n[o].push(u)):n[o]=u}return n},upload:function(e,n,s,i,a){r.isNumber(i)||null!=a||(a=i,i=null),e||(e=location.pathname);var o="POST",c=e.indexOf(" "),p=null;-1!==c&&(o=e.substring(0,c).toUpperCase());var d="!"===o.substring(0,1);d&&(o=o.substring(1));var v={};(p=e.match(/\{.*?\}/g))&&(e=e.replace(p,"").replace(/\s{2,}/g," "),p=new Function("return "+p)(),r.isObject(p)&&(v=p)),e=e.substring(c).trim().$env(),r.isNumber(s)&&(i=s,s=void 0);var g={};if(g.url=e,g.process=!0,g.error=!1,g.upload=!0,g.method=o,g.data=n,t.eventer.emit("request",g),!g.cancel)return setTimeout(function(){var e=new XMLHttpRequest;d&&(e.withCredentials=!0),e.addEventListener("load",function(){var e=this.responseText;try{e=PARSE(e,u.jsondate)}catch(e){}a&&a(100),g.response=e,g.status=this.status,g.text=this.statusText,g.error=this.status>399,g.headers=l(this.getAllResponseHeaders()),t.eventer.emit("response",g),g.process&&!g.cancel&&(!e&&g.error&&(e=g.response=this.status+": "+this.statusText),!g.error||u.ajaxerrors?r.isString(s)?remap(s.env(),e):s&&s(e,null,g):(t.eventer.emit("error",g),g.process&&r.isFunction(s)&&s({},e,g)))},!1),e.upload.onprogress=function(e){if(a){var t=0;e.lengthComputable&&(t=Math.round(100*e.loaded/e.total)),a(t,e.transferSpeed,e.timeRemaining)}},e.open(o,f(g.url));for(var i=Object.keys(u.headers),c=0;c<i.length;c++)e.setRequestHeader(i[c].env(),u.headers[i[c]].env());if(v)for(i=Object.keys(v),c=0;c<i.length;c++)e.setRequestHeader(i[c],v[i[c]]);e.send(n)},i||0),W}}}});
//# sourceMappingURL=../sourcemaps/views/http.js.map
