/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["../jc","../langx","../topic","./cache"],function(e,t,r,n){function s(e,t){var r=e.replace("--\x3e","->").indexOf("->");-1!==r&&(t=t[e.substring(0,r).trim()],e=e.substring(r+3).trim()),immSetx(e,t)}var a={},i={};function o(e){var t={};return e.split("\n").forEach(function(e){var r=e.indexOf(":");-1!==r&&(t[e.substring(0,r).toLowerCase()]=e.substring(r+1).trim())}),t}function u(e,r,s,a,i){s&&!s.version&&M.$version&&(s.version=M.$version),s&&!s.language&&M.$language&&(s.language=M.$language),s=t.stringify(s);var o=t.hashCode(e+"#"+r.replace(/\//g,"")+s).toString();return n.set(o,a,i)}function c(e,t){if(i.makeurl&&(e=i.makeurl(e)),t)return e;var r=[],n=encodeURIComponent;return M.$version&&r.push("version="+n(M.$version)),M.$language&&r.push("language="+n(M.$language)),r.length?(e+=-1==e.indexOf("?")?"?":"&")+r.join("&"):e}function l(e,n,s,a,i,o){var u,l=(e=e.$env().replace(/<.*?>/,function(e){return u=e.substring(1,e.length-1).trim(),""}).trim()).substring(0,1),d="once "===e.substring(0,5).toLowerCase();if(t.isFunction(s)?(t.isFunction(a)?(o=a,i=!0):typeof i===TYPE_FN&&(o=i,i=!0),a=s,s="body"):t.isFunction(i)&&(o=i,i=!0),u){var v="()"===u.substring(u.length-2);v&&(u=u.substring(0,u.length-2));var g=GET(u);if(v&&t.isFunction(g)){if(g())return void(a&&a(0))}else if(g)return void(a&&a(0))}"//"===e.substring(0,2)&&(e=location.protocol+e);var m=e.lastIndexOf(" ."),h="";if(-1!==m&&(h=e.substring(m).trim().toLowerCase(),e=e.substring(0,m).trim()),"!"===l||d){if(e=d?e.substring(5):e.substring(1),statics[e])return a&&(2===statics[e]?a(0):t.wait(function(){return 2===statics[e]},function(){a(0)})),W;statics[e]=1}if(s&&s.setPath&&(s=s.element),s||(s="body"),!h)if(-1!==(m=e.lastIndexOf("?"))){var y=e.lastIndexOf(".",m);-1!==y&&(h=e.substring(y,m).toLowerCase())}else-1!==(m=e.lastIndexOf("."))&&(h=e.substring(m).toLowerCase());var T=document;if(".js"===h){var E=T.createElement("script");return E.type="text/javascript",E.async=!1,E.onload=function(){statics[e]=2,a&&a(1),setTimeout(compile,300)},E.src=c(e,!0),T.getElementsByTagName("head")[0].appendChild(E),r.emit("import",e,$(E)),this}if(".css"===h){var b=T.createElement("link");return b.type="text/css",b.rel="stylesheet",b.href=c(e,!0),T.getElementsByTagName("head")[0].appendChild(b),statics[e]=2,a&&setTimeout(a,200,1),r.emit("import",e,$(b)),this}return t.wait(function(){return!!W.jQuery},function(){statics[e]=2;var u="import"+HASH(e),c=function(n,c,l){if(n){e="$import"+e,o&&(n=o(n,l));var p=REGCOM.test(n);n=importscripts(importstyles(n,u)).trim(),s=$(s),n&&(!1===i?s.html(n):s.append(n)),setTimeout(function(){p&&compile(),a&&t.wait(function(){return 0==C.is},function(){a(1)}),r.emit("import",e,s)},10)}else a&&a(0)};n?f("GET "+e,null,c,n):p("GET "+e,c)}),W}function p(e,t,n,u){typeof e===TYPE_FN&&(u=n,n=t,t=e,e=location.pathname);var l,p=typeof t,f=EMPTYARRAY;n||p!==TYPE_FN&&p!==TYPE_S||(u=n,n=t,t=void 0);var d=e.indexOf(" ");if(-1===d)return W;var v=!1;e=e.replace(/\srepeat/i,function(){return v=!0,""}),v&&(f=[e,t,n,u]);var g=e.substring(0,d).toUpperCase(),m="!"===g.substring(0,1);m&&(g=g.substring(1));var h={};return(l=e.match(/\{.*?\}/g))&&(e=e.replace(l,"").replace(/\s{2,}/g," "),typeof(l=new Function("return "+l)())===TYPE_O&&(h=l)),e=e.substring(d).trim().$env(),setTimeout(function(){if("GET"===g&&t){var u=typeof t===TYPE_S?t:jQuery.param(t,!0);u&&(e+="?"+u)}var l={};l.method=g,l.converters=i.jsonconverter,"GET"!==g&&(typeof t===TYPE_S?l.data=t:(l.contentType="application/json; charset=utf-8",l.data=STRINGIFY(t))),l.headers=$.extend(h,i.headers),e.match(/http:\/\/|https:\/\//i)?(l.crossDomain=!0,delete l.headers["X-Requested-With"],m&&(l.xhrFields={withCredentials:!0})):e=e.ROOT();var p=e.match(/\([a-z0-9\-.,]+\)/i);if(p){e=e.replace(p,"").replace(/\s+/g,""),l.url=e,p=p.toString().replace(/\(|\)/g,"").split(",");for(var d=0;d<p.length;d++){var y=a[p[d].trim()];y&&y(l)}}if(l.url||(l.url=e),r.emit("request",l),!l.cancel){l.type=l.method,delete l.method;var T={};T.url=l.url,T.process=!0,T.error=!1,T.upload=!1,T.method=g,T.data=t,delete l.url,l.success=function(e,t,a){T.response=e,T.status=a.status||999,T.text=t,T.headers=o(a.getAllResponseHeaders()),r.emit("response",T),T.process&&!T.cancel&&(typeof n===TYPE_S?s(n,T.response):n&&n.call(T,T.response,void 0,T))},l.error=function(e,t){var a=e.status;if(!v||a&&408!==a&&502!==a&&503!==a&&504!==a&&509!==a){T.response=e.responseText,T.status=a||999,T.text=t,T.error=!0,T.headers=o(e.getAllResponseHeaders());var u=T.headers["content-type"];if(u&&-1!==u.indexOf("/json"))try{T.response=PARSE(T.response,i.jsondate)}catch(e){}r.emit("response",T),!T.cancel&&T.process&&(i.ajaxerrors?typeof n===TYPE_S?s(n,T.response):n&&n.call(T,T.response,T.status,T):(r.emit("error",T),typeof n===TYPE_FN&&n.call(T,T.response,T.status,T)))}else setTimeout(function(){f[0]+=" REPEAT",W.AJAX.apply(M,f)},i.delayrepeat)},$.ajax(c(T.url),l)}},u||0),this}function f(e,t,r,n,a,i,o){var c=typeof t;(c===TYPE_FN||c===TYPE_S&&typeof r===TYPE_S&&typeof n!==TYPE_S)&&(i=a,a=n,n=r,r=t,t=null),"boolean"==typeof a&&(i=!0===a,a=0);var l=e.indexOf(" ");if(-1===l)return W;var f=e.substring(0,l).toUpperCase(),d=e.substring(l).trim().$env();return setTimeout(function(){var a=i?void 0:u(f,d,t,void 0,n);if(void 0===a)p(e,t,function(e,a){a&&(e=a),u(f,d,t,e,n),typeof r===TYPE_S?s(r,e):r(e,!1)});else{var c=o?STRINGIFY(a):null;if(typeof r===TYPE_S?s(r,a):r(a,!0),!o)return;p(e,t,function(e,a){a&&(e=a),c!==STRINGIFY(e)&&(u(f,d,t,e,n),typeof r===TYPE_S?s(r,e):r(e,!1,!0))})}},a||1),this}return i.ajaxerrors=!1,i.pingdata={},i.baseurl="",i.makeurl=null,i.delayrepeat=2e3,i.jsondate=!0,i.jsonconverter={"text json":function(e){return PARSE(e)}},i.headers={"X-Requested-With":"XMLHttpRequest"},e.http={defaults:i,ajax:p,ajaxCache:f,ajaxCacheReview:function(e,t,r,n,s,a){return f(e,t,r,n,s,a,!0)},configure:function(e,t){return a[e]=t,this},import2:function(e,r,n,s,a){return e instanceof Array?(t.isFunction(r)&&(a=s,s=n,n=r,r=null),e.wait(function(e,t){l(e,null,r,t,s,a)},function(){n&&n()})):l(e,null,r,n,s,a),this},importCache:l,makeParams:function(e,t,r){var n,s=location;typeof e===TYPE_O&&(r=t,t=e,e=s.pathname+s.search);var a=e.indexOf("?");-1!==a?(n=M.parseQuery(e.substring(a+1)),e=e.substring(0,a)):n={};for(var i=Object.keys(t),o=0,u=i.length;o<u;o++){var c=i[o];n[c]=t[c]}var l=$.param(n,null==r||!0===r);return e+(l?"?"+l:"")},ping:function(e,t,r){if(null==navigator.onLine||navigator.onLine){"boolean"==typeof t&&(r=t,t=0);var n=(e=e.$env()).indexOf(" "),s="GET";-1!==n&&(s=e.substring(0,n).toUpperCase(),e=e.substring(n).trim());var a={},o=$.param(i.pingdata);return o&&(n=e.lastIndexOf("?"),e+=-1===n?"?"+o:"&"+o),a.type=s,a.headers={"x-ping":location.pathname,"x-cookies":navigator.cookieEnabled?"1":"0","x-referrer":document.referrer},a.success=function(e){if(e)try{new Function(e)()}catch(e){}},r&&$.ajax(c(e),a),setInterval(function(){$.ajax(c(e),a)},t||3e4)}},parseQuery:function(e){if(e||(e=location.search),!e)return{};var t=e.indexOf("?");-1!==t&&(e=e.substring(t+1));for(var r=e.split("&"),n={},s=0,a=r.length;s<a;s++){var i=r[s].split("="),o=i[0],u=decodeURIComponent((i[1]||"").replace(/\+/g,"%20"));n[o]?(n[o]instanceof Array||(n[o]=[n[o]]),n[o].push(u)):n[o]=u}return n},upload:function(e,n,a,u,l){t.isNumber(u)||null!=l||(l=u,u=null),e||(e=location.pathname);var p="POST",f=e.indexOf(" "),d=null;-1!==f&&(p=e.substring(0,f).toUpperCase());var v="!"===p.substring(0,1);v&&(p=p.substring(1));var g={};(d=e.match(/\{.*?\}/g))&&(e=e.replace(d,"").replace(/\s{2,}/g," "),typeof(d=new Function("return "+d)())===TYPE_O&&(g=d)),e=e.substring(f).trim().$env(),typeof a===TYPE_N&&(u=a,a=void 0);var m={};if(m.url=e,m.process=!0,m.error=!1,m.upload=!0,m.method=p,m.data=n,r.emit("request",m),!m.cancel)return setTimeout(function(){var e=new XMLHttpRequest;v&&(e.withCredentials=!0),e.addEventListener("load",function(){var e=this.responseText;try{e=PARSE(e,i.jsondate)}catch(e){}l&&(typeof l===TYPE_S?s(l,100):l(100)),m.response=e,m.status=this.status,m.text=this.statusText,m.error=this.status>399,m.headers=o(this.getAllResponseHeaders()),r.emit("response",m),m.process&&!m.cancel&&(!e&&m.error&&(e=m.response=this.status+": "+this.statusText),!m.error||i.ajaxerrors?typeof a===TYPE_S?s(a.env(),e):a&&a(e,null,m):(r.emit("error",m),m.process&&typeof a===TYPE_FN&&a({},e,m)))},!1),e.upload.onprogress=function(e){if(l){var r=0;e.lengthComputable&&(r=Math.round(100*e.loaded/e.total)),t.isString(l)?s(l.env(),r):l(r,e.transferSpeed,e.timeRemaining)}},e.open(p,c(m.url));for(var u=Object.keys(i.headers),f=0;f<u.length;f++)e.setRequestHeader(u[f].env(),i.headers[u[f]].env());if(g)for(u=Object.keys(g),f=0;f<u.length;f++)e.setRequestHeader(u[f],g[u[f]]);e.send(n)},u||0),W},uptodate:function(e,n,s,a){t.isFunction(n)&&(a=s,s=n,n="");var i=(new Date).add(e);r.on("knockknock",function(){if(!(i>t.now())&&a&&a()){var e=setTimeout(function(){var e=window.location;n?e.href=n.$env():e.reload(!0)},5e3);s&&s(e)}})}}});
//# sourceMappingURL=../sourcemaps/utils/http.js.map
