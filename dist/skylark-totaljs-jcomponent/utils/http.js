/**
 * skylark-totaljs-jcomponent - A version of totaljs jcomponent that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-totaljs-jcomponent/
 * @license MIT
 */
define(["../jc","../langx","skylark-net-http/Xhr","./domx","./storage"],function(e,t,r,n,s){var i=/(data-jc|data-jc-url|data-jc-import|data-bind|bind)=|COMPONENT\(/,a=t.statics,o={},u={};function c(e,t){t.url=e;var n=r.request(t.url,t);return(n=n.then(function(){t.success&&t.success.apply(this,arguments)},function(){t.error&&t.error.apply(this,arguments)})).success=n.done,n.error=n.fail,n.complete=n.always,n}function l(e){var t={};return e.split("\n").forEach(function(e){var r=e.indexOf(":");-1!==r&&(t[e.substring(0,r).toLowerCase()]=e.substring(r+1).trim())}),t}function p(e,r,n,i,a){n&&!n.version&&M.$version&&(n.version=M.$version),n&&!n.language&&M.$language&&(n.language=M.$language),n=t.stringify(n);var o=t.hashCode(e+"#"+r.replace(/\//g,"")+n).toString();return s.set(o,i,a)}function f(e,t){var r=[];encodeURIComponent;return r.length?(e+=-1==e.indexOf("?")?"?":"&")+r.join("&"):e}function d(e,r,s,o,u,c){var l,p=(e=e.$env().replace(/<.*?>/,function(e){return l=e.substring(1,e.length-1).trim(),""}).trim()).substring(0,1),d="once "===e.substring(0,5).toLowerCase();if(t.isFunction(s)?(t.isFunction(o)?(c=o,u=!0):t.isFunction(u)&&(c=u,u=!0),o=s,s="body"):t.isFunction(u)&&(c=u,u=!0),l){var v="()"===l.substring(l.length-2);v&&(l=l.substring(0,l.length-2));var m=GET(l);if(v&&t.isFunction(m)){if(m())return void(o&&o(0))}else if(m)return void(o&&o(0))}"//"===e.substring(0,2)&&(e=location.protocol+e);var b=e.lastIndexOf(" ."),x="";if(-1!==b&&(x=e.substring(b).trim().toLowerCase(),e=e.substring(0,b).trim()),"!"===p||d){if(e=d?e.substring(5):e.substring(1),a[e])return o&&(2===a[e]?o(0):t.wait(function(){return 2===a[e]},function(){o(0)})),W;a[e]=1}if(s&&s.setPath&&(s=s.element),s||(s="body"),!x)if(-1!==(b=e.lastIndexOf("?"))){var y=e.lastIndexOf(".",b);-1!==y&&(x=e.substring(y,b).toLowerCase())}else-1!==(b=e.lastIndexOf("."))&&(x=e.substring(b).toLowerCase());var j=document;if(".js"===x){var T=j.createElement("script");return T.type="text/javascript",T.async=!1,T.onload=function(){a[e]=2,o&&o(1),setTimeout(compile,300)},T.src=f(e),j.getElementsByTagName("head")[0].appendChild(T),topic.emit("import",e,$(T)),this}if(".css"===x){var O=j.createElement("link");return O.type="text/css",O.rel="stylesheet",O.href=f(e),j.getElementsByTagName("head")[0].appendChild(O),a[e]=2,o&&setTimeout(o,200,1),topic.emit("import",e,$(O)),this}return t.wait(function(){return!!W.jQuery},function(){a[e]=2;var l="import"+t.hashCode(e),p=function(r,a,p){if(r){e="$import"+e,c&&(r=c(r,p));var f=i.test(r);r=n.importscripts(n.importstyles(r,l)).trim(),s=$(s),r&&(!1===u?s.html(r):s.append(r)),setTimeout(function(){f&&compile(),o&&t.wait(function(){return 0==C.is},function(){o(1)}),topic.emit("import",e,s)},10)}else o&&o(0)};r?h("GET "+e,null,p,r):g("GET "+e,p)}),W}function g(e,r,n,s){t.isFunction(e)&&(s=n,n=r,r=e,e=location.pathname);var i,a=typeof r,p=EMPTYARRAY;n||"function"!==a&&"string"!==a||(s=n,n=r,r=void 0);var d=e.indexOf(" ");if(-1===d)return W;var g=!1;e=e.replace(/\srepeat/i,function(){return g=!0,""}),g&&(p=[e,r,n,s]);var h=e.substring(0,d).toUpperCase(),v="!"===h.substring(0,1);v&&(h=h.substring(1));var m={};return(i=e.match(/\{.*?\}/g))&&(e=e.replace(i,"").replace(/\s{2,}/g," "),i=new Function("return "+i)(),t.isObject(i)&&(m=i)),e=e.substring(d).trim().$env(),setTimeout(function(){if("GET"===h&&r){var s=t.isString(r)?r:jQuery.param(r,!0);s&&(e+="?"+s)}var i={};i.method=h,i.converters=u.jsonconverter,"GET"!==h&&(t.isString(r)?i.data=r:(i.contentType="application/json; charset=utf-8",i.data=STRINGIFY(r))),i.headers=t.extend(m,u.headers),e.match(/http:\/\/|https:\/\//i)?(i.crossDomain=!0,delete i.headers["X-Requested-With"],v&&(i.xhrFields={withCredentials:!0})):e=e.ROOT();var a=e.match(/\([a-z0-9\-.,]+\)/i);if(a){e=e.replace(a,"").replace(/\s+/g,""),i.url=e,a=a.toString().replace(/\(|\)/g,"").split(",");for(var d=0;d<a.length;d++){var b=o[a[d].trim()];b&&b(i)}}if(i.url||(i.url=e),!i.cancel){i.type=i.method,delete i.method;var x={};x.url=i.url,x.process=!0,x.error=!1,x.upload=!1,x.method=h,x.data=r,delete i.url,i.success=function(e,t,r){x.response=e,x.status=r.status||999,x.text=t,x.headers=l(r.getAllResponseHeaders()),x.process&&!x.cancel&&n&&n.call(x,x.response,void 0,x)},i.error=function(e,r){var s=e.status;if(!g||s&&408!==s&&502!==s&&503!==s&&504!==s&&509!==s){x.response=e.responseText,x.status=s||999,x.text=r,x.error=!0,x.headers=l(e.getAllResponseHeaders());var i=x.headers["content-type"];if(i&&-1!==i.indexOf("/json"))try{x.response=PARSE(x.response,u.jsondate)}catch(e){}!x.cancel&&x.process&&(u.ajaxerrors?n&&n.call(x,x.response,x.status,x):t.isFunction(n)&&n.call(x,x.response,x.status,x))}else setTimeout(function(){p[0]+=" REPEAT",W.AJAX.apply(M,p)},u.delayrepeat)},c(f(x.url),i)}},s||0),this}function h(e,r,n,s,i,a,o){(t.isFunction(r)||t.isString(r)&&t.isString(n)&&!t.isString(s))&&(a=i,i=s,s=n,n=r,r=null),t.isBoolean(i)&&(a=!0===i,i=0);var u=e.indexOf(" ");if(-1===u)return W;var c=e.substring(0,u).toUpperCase(),l=e.substring(u).trim().$env();return setTimeout(function(){var t=a?void 0:p(c,l,r,void 0,s);if(void 0===t)g(e,r,function(e,t){t&&(e=t),p(c,l,r,e,s),n(e,!1)});else{var i=o?STRINGIFY(t):null;if(n(t,!0),!o)return;g(e,r,function(e,t){t&&(e=t),i!==STRINGIFY(e)&&(p(c,l,r,e,s),n(e,!1,!0))})}},i||1),this}return u.ajaxerrors=!1,u.pingdata={},u.baseurl="",u.makeurl=null,u.delayrepeat=2e3,u.jsondate=!0,u.jsonconverter={"text json":function(e){return PARSE(e)}},u.headers={"X-Requested-With":"XMLHttpRequest"},e.http={defaults:u,ajax:g,ajaxCache:h,ajaxCacheReview:function(e,t,r,n,s,i){return h(e,t,r,n,s,i,!0)},configure:function(e,t){return o[e]=t,this},import:function(e,r,n,s,i){return e instanceof Array?(t.isFunction(r)&&(i=s,s=n,n=r,r=null),e.wait(function(e,t){d(e,null,r,t,s,i)},function(){n&&n()})):d(e,null,r,n,s,i),this},importCache:d,makeParams:function(e,n,s){var i,a=location;t.isObject(e)&&(s=n,n=e,e=a.pathname+a.search);var o=e.indexOf("?");-1!==o?(i=M.parseQuery(e.substring(o+1)),e=e.substring(0,o)):i={};for(var u=Object.keys(n),c=0,l=u.length;c<l;c++){var p=u[c];i[p]=n[p]}var f=r.param(i,null==s||!0===s);return e+(f?"?"+f:"")},makeurl:f,ping:function(e,t,r){if(null==navigator.onLine||navigator.onLine){"boolean"==typeof t&&(r=t,t=0);var n=(e=e.$env()).indexOf(" "),s="GET";-1!==n&&(s=e.substring(0,n).toUpperCase(),e=e.substring(n).trim());var i={},a=$langx.Xhr.param(u.pingdata);return a&&(n=e.lastIndexOf("?"),e+=-1===n?"?"+a:"&"+a),i.type=s,i.headers={"x-ping":location.pathname,"x-cookies":navigator.cookieEnabled?"1":"0","x-referrer":document.referrer},i.success=function(e){if(e)try{new Function(e)()}catch(e){}},r&&c(f(e),i),setInterval(function(){c(f(e),i)},t||3e4)}},parseQuery:function(e){if(e||(e=location.search),!e)return{};var t=e.indexOf("?");-1!==t&&(e=e.substring(t+1));for(var r=e.split("&"),n={},s=0,i=r.length;s<i;s++){var a=r[s].split("="),o=a[0],u=decodeURIComponent((a[1]||"").replace(/\+/g,"%20"));n[o]?(n[o]instanceof Array||(n[o]=[n[o]]),n[o].push(u)):n[o]=u}return n},upload:function(e,r,n,s,i){t.isNumber(s)||null!=i||(i=s,s=null),e||(e=location.pathname);var a="POST",o=e.indexOf(" "),c=null;-1!==o&&(a=e.substring(0,o).toUpperCase());var p="!"===a.substring(0,1);p&&(a=a.substring(1));var d={};(c=e.match(/\{.*?\}/g))&&(e=e.replace(c,"").replace(/\s{2,}/g," "),c=new Function("return "+c)(),t.isObject(c)&&(d=c)),e=e.substring(o).trim().$env(),t.isNumber(n)&&(s=n,n=void 0);var g={};if(g.url=e,g.process=!0,g.error=!1,g.upload=!0,g.method=a,g.data=r,topic.emit("request",g),!g.cancel)return setTimeout(function(){var e=new XMLHttpRequest;p&&(e.withCredentials=!0),e.addEventListener("load",function(){var e=this.responseText;try{e=PARSE(e,u.jsondate)}catch(e){}i&&i(100),g.response=e,g.status=this.status,g.text=this.statusText,g.error=this.status>399,g.headers=l(this.getAllResponseHeaders()),topic.emit("response",g),g.process&&!g.cancel&&(!e&&g.error&&(e=g.response=this.status+": "+this.statusText),!g.error||u.ajaxerrors?t.isString(n)?remap(n.env(),e):n&&n(e,null,g):(topic.emit("error",g),g.process&&t.isFunction(n)&&n({},e,g)))},!1),e.upload.onprogress=function(e){if(i){var t=0;e.lengthComputable&&(t=Math.round(100*e.loaded/e.total)),i(t,e.transferSpeed,e.timeRemaining)}},e.open(a,f(g.url));for(var s=Object.keys(u.headers),o=0;o<s.length;o++)e.setRequestHeader(s[o].env(),u.headers[s[o]].env());if(d)for(s=Object.keys(d),o=0;o<s.length;o++)e.setRequestHeader(s[o],d[s[o]]);e.send(r)},s||0),W}}});
//# sourceMappingURL=../sourcemaps/utils/http.js.map
